<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¥¬çš„æ¸©é¦¨æ—¶å…‰ç›¸å†Œ - å¥½å‹æ¡£æ¡ˆç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=ZCOOL+XiaoWei&display=swap" rel="stylesheet">
    <style>
        /* ä¿æŒåŸæœ‰CSSæ ·å¼ä¸å˜ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary-color: #A8E6CF;
            --secondary-color: #FFD3B6;
            --accent-color: #FFAAA5;
            --light-color: #FFE8E8;
            --dark-color: #7C9EB2;
            --text-color: #5A5A5A;
            --shadow: 0 8px 20px rgba(168, 230, 207, 0.3);
            --round: 25px;
        }
        
        body {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: var(--text-color);
            font-family: 'ZCOOL XiaoWei', serif;
            position: relative;
            overflow-x: hidden;
        }
        
        /* ... ä¿æŒæ‰€æœ‰åŸæœ‰çš„CSSæ ·å¼ ... */
        
        /* æ•°æ®çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .data-status {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 10px 15px;
            border-radius: 15px;
            font-size: 0.8rem;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            font-family: 'Ma Shan Zheng', cursive;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            gap: 8px;
            border: 2px solid var(--primary-color);
        }
        
        .data-status.online::before {
            content: '';
            width: 10px;
            height: 10px;
            background-color: #4CAF50;
            border-radius: 50%;
            display: inline-block;
            animation: pulse 2s infinite;
        }
        
        .data-status.offline::before {
            content: '';
            width: 10px;
            height: 10px;
            background-color: #FF5252;
            border-radius: 50%;
            display: inline-block;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* æ•°æ®å¤‡ä»½æŒ‰é’® */
        .data-backup {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .backup-btn {
            background: linear-gradient(90deg, #7C9EB2 0%, #A8E6CF 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 15px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-family: 'Ma Shan Zheng', cursive;
            box-shadow: 0 5px 15px rgba(124, 158, 178, 0.4);
        }
        
        .backup-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(124, 158, 178, 0.6);
        }
        
        .backup-btn i {
            margin-right: 8px;
        }
    </style>
</head>
<body>
    <!-- èƒŒæ™¯è£…é¥°å…ƒç´  -->
    <div class="decoration dec-1">ğŸ¥¬</div>
    <div class="decoration dec-2">ğŸ¥¬</div>
    <div class="decoration dec-3">ğŸ¥¬</div>
    <div class="decoration dec-4">ğŸ¥¬</div>
    <div class="decoration dec-5">ğŸ¥¬</div>
    
    <!-- æ•°æ®çŠ¶æ€æŒ‡ç¤ºå™¨ -->
    <div class="data-status online" id="data-status">
        <span>æ•°æ®å·²ä¿å­˜</span>
    </div>
    
    <!-- æ•°æ®å¤‡ä»½æŒ‰é’® -->
    <div class="data-backup">
        <button class="backup-btn" id="backup-btn">
            <i class="fas fa-download"></i> å¤‡ä»½æ•°æ®
        </button>
    </div>
    
    <div class="container">
        <!-- ä¿æŒåŸæœ‰çš„HTMLç»“æ„ä¸å˜ -->
        <header>
            <div class="title-container">
                <h1><span>ğŸ¥¬</span> çš„å°å®‡å®™ <span>ğŸ¥¬</span></h1>
                <p>è®°å½•ğŸ¥¬å’Œæœ‹å‹ä»¬çš„ç¾å¥½ç¬é—´ï¼Œä¸Šä¼ ç…§ç‰‡å’Œç•™è¨€ï¼Œç•™ä¸‹æ¸©æš–å›å¿†ï¼</p>
                <div class="greeting">æ¬¢è¿æ¥åˆ°ğŸ¥¬çš„æ¸©é¦¨æ—¶å…‰å°å±‹ï¼</div>
            </div>
        </header>
        
        <div class="view-switcher">
            <button class="view-btn active" id="admin-btn">
                <i class="fas fa-heart"></i> ğŸ¥¬çš„ç®¡ç†ç©ºé—´
            </button>
            <button class="view-btn" id="user-btn">
                <i class="fas fa-user-friends"></i> æœ‹å‹æ¥è®¿å…¥å£
            </button>
        </div>
        
        <!-- ç®¡ç†å‘˜è§†è§’ -->
        <div class="view-container active" id="admin-view">
            <!-- ... ä¿æŒåŸæœ‰çš„ç®¡ç†å‘˜ç•Œé¢ ... -->
        </div>
        
        <!-- ç”¨æˆ·è§†è§’ -->
        <div class="view-container" id="user-view">
            <!-- ... ä¿æŒåŸæœ‰çš„ç”¨æˆ·ç•Œé¢ ... -->
        </div>
        
        <footer>
            <p>Â© ğŸ¥¬çš„æ¸©é¦¨æ—¶å…‰ç›¸å†Œ | æ‰€æœ‰æ•°æ®éƒ½ä¼šä¿å­˜åœ¨ä½ çš„æµè§ˆå™¨ä¸­ï¼Œè¯·æ”¾å¿ƒä½¿ç”¨</p>
            <p style="margin-top: 10px;">ğŸ¥¬ ä¼šä¸€ç›´è®°å½•ä¸æ¯ä½æœ‹å‹çš„ç¾å¥½æ—¶å…‰ ğŸ¥¬</p>
        </footer>
    </div>
    
    <!-- å¥½å‹ç®¡ç†æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="manage-friend-modal">
        <!-- ... ä¿æŒåŸæœ‰çš„æ¨¡æ€æ¡† ... -->
    </div>
    
    <!-- æ•°æ®å¤‡ä»½/æ¢å¤æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="data-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-database"></i> æ•°æ®ç®¡ç†</h3>
                <button class="close-modal" id="close-data-modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-content">
                <div class="section">
                    <h3 class="section-title"><i class="fas fa-download"></i> å¤‡ä»½æ•°æ®</h3>
                    <p>å°†å½“å‰æ‰€æœ‰å¥½å‹æ¡£æ¡ˆæ•°æ®å¤‡ä»½åˆ°æ–‡ä»¶ä¸­ï¼š</p>
                    <button class="btn" id="export-data-btn">
                        <i class="fas fa-file-export"></i> å¯¼å‡ºæ•°æ®æ–‡ä»¶
                    </button>
                </div>
                
                <div class="section">
                    <h3 class="section-title"><i class="fas fa-upload"></i> æ¢å¤æ•°æ®</h3>
                    <p>ä»å¤‡ä»½æ–‡ä»¶ä¸­æ¢å¤å¥½å‹æ¡£æ¡ˆæ•°æ®ï¼š</p>
                    <div class="input-group">
                        <label for="import-data-file">é€‰æ‹©å¤‡ä»½æ–‡ä»¶</label>
                        <input type="file" id="import-data-file" accept=".json">
                    </div>
                    <button class="btn" id="import-data-btn">
                        <i class="fas fa-file-import"></i> å¯¼å…¥æ•°æ®
                    </button>
                </div>
                
                <div class="section">
                    <h3 class="section-title"><i class="fas fa-trash-alt"></i> æ•°æ®ç»Ÿè®¡</h3>
                    <p>å½“å‰æ•°æ®çŠ¶æ€ï¼š</p>
                    <div id="data-stats">
                        <p>å¥½å‹æ•°é‡ï¼š<span id="friends-count">0</span></p>
                        <p>æ€»ç…§ç‰‡æ•°é‡ï¼š<span id="photos-count-total">0</span></p>
                        <p>æ€»ç•™è¨€æ•°é‡ï¼š<span id="messages-count-total">0</span></p>
                        <p>æœ€åæ›´æ–°æ—¶é—´ï¼š<span id="last-updated">ä»æœª</span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- é€šçŸ¥ç»„ä»¶ -->
    <div id="notification-container"></div>
    
    <script>
        // ç­‰å¾…DOMå®Œå…¨åŠ è½½
        document.addEventListener('DOMContentLoaded', function() {
            
            console.log("ğŸ¥¬ é¡µé¢è„šæœ¬å·²æˆåŠŸåŠ è½½ - GitHub Pagesä¼˜åŒ–ç‰ˆ");
            
            // ==================== å…³é”®ä¿®å¤ï¼šGitHub Pages å…¼å®¹æ€§å¢å¼º ====================
            
            // 1. æ•°æ®å­˜å‚¨å¢å¼º - ä½¿ç”¨å¤šé‡å­˜å‚¨ç­–ç•¥
            const STORAGE_KEY = 've_space_friends_data_v2'; // ä½¿ç”¨æ–°çš„keyé¿å…å†²çª
            const BACKUP_KEY = 've_space_friends_backup'; // å¤‡ä»½key
            
            // 2. æ·»åŠ ç‰ˆæœ¬æ§åˆ¶ï¼Œé˜²æ­¢æ•°æ®ç»“æ„å˜åŒ–å¯¼è‡´çš„é—®é¢˜
            const DATA_VERSION = '2.0.0';
            const VERSION_KEY = 've_space_data_version';
            
            // çº¯è‰²å¤´åƒé¢œè‰²æ•°ç»„
            const avatarColors = [
                'avatar-color-1',
                'avatar-color-2', 
                'avatar-color-3',
                'avatar-color-4',
                'avatar-color-5',
                'avatar-color-6'
            ];
            
            // DOM å…ƒç´ 
            const adminBtn = document.getElementById('admin-btn');
            const userBtn = document.getElementById('user-btn');
            const adminView = document.getElementById('admin-view');
            const userView = document.getElementById('user-view');
            const passwordSection = document.getElementById('password-section');
            const adminContent = document.getElementById('admin-content');
            const loginBtn = document.getElementById('login-btn');
            const adminPasswordInput = document.getElementById('admin-password');
            const friendForm = document.getElementById('friend-form');
            const friendNameInput = document.getElementById('friend-name');
            const adminMessageInput = document.getElementById('admin-message');
            const photosUpload = document.getElementById('photos-upload');
            const photosInput = document.getElementById('photos-input');
            const photosPreview = document.getElementById('photos-preview');
            const photosCount = document.getElementById('photos-count');
            const friendList = document.getElementById('friend-list');
            const userNameInput = document.getElementById('user-name');
            const searchBtn = document.getElementById('search-btn');
            const userResult = document.getElementById('user-result');
            const timelineSection = document.getElementById('timeline-section');
            const newMessageSection = document.getElementById('new-message-section');
            const userMessageInput = document.getElementById('user-message');
            const sendMessageBtn = document.getElementById('send-message-btn');
            const notificationContainer = document.getElementById('notification-container');
            const timelineFilter = document.getElementById('timeline-filter');
            const adminBackBtn = document.getElementById('admin-back-btn');
            const userBackBtn = document.getElementById('user-back-btn');
            const dataStatus = document.getElementById('data-status');
            const backupBtn = document.getElementById('backup-btn');
            
            // ç®¡ç†æ¨¡æ€æ¡†å…ƒç´ 
            const manageFriendModal = document.getElementById('manage-friend-modal');
            const closeManageModalBtn = document.getElementById('close-manage-modal');
            const manageFriendNameInput = document.getElementById('manage-friend-name');
            const manageAdminMessageInput = document.getElementById('manage-admin-message');
            const existingPhotosContainer = document.getElementById('existing-photos');
            const managePhotosUpload = document.getElementById('manage-photos-upload');
            const managePhotosInput = document.getElementById('manage-photos-input');
            const managePhotosPreview = document.getElementById('manage-photos-preview');
            const managePhotosCount = document.getElementById('manage-photos-count');
            const manageNewMessageInput = document.getElementById('manage-new-message');
            const saveManageBtn = document.getElementById('save-manage-btn');
            const addMessageBtn = document.getElementById('add-message-btn');
            
            // æ•°æ®ç®¡ç†æ¨¡æ€æ¡†å…ƒç´ 
            const dataModal = document.getElementById('data-modal');
            const closeDataModalBtn = document.getElementById('close-data-modal');
            const exportDataBtn = document.getElementById('export-data-btn');
            const importDataFile = document.getElementById('import-data-file');
            const importDataBtn = document.getElementById('import-data-btn');
            const friendsCountSpan = document.getElementById('friends-count');
            const photosCountTotalSpan = document.getElementById('photos-count-total');
            const messagesCountTotalSpan = document.getElementById('messages-count-total');
            const lastUpdatedSpan = document.getElementById('last-updated');
            
            // å­˜å‚¨å·²é€‰æ‹©ä½†æœªä¸Šä¼ çš„ç…§ç‰‡ï¼ˆåˆ›å»ºæ–°æ¡£æ¡ˆï¼‰
            let selectedPhotos = [];
            // å­˜å‚¨å·²é€‰æ‹©ä½†æœªä¸Šä¼ çš„ç…§ç‰‡ï¼ˆç®¡ç†æ¡£æ¡ˆï¼‰
            let selectedManagePhotos = [];
            
            // å½“å‰é€‰ä¸­çš„å¥½å‹ï¼ˆç”¨æˆ·è§†è§’ï¼‰
            let currentFriend = null;
            // å½“å‰æ—¶é—´çº¿è¿‡æ»¤å™¨
            let currentFilter = "all";
            // å½“å‰æ­£åœ¨ç®¡ç†çš„å¥½å‹
            let managingFriend = null;
            
            // ç®¡ç†å‘˜å¯†ç 
            const ADMIN_PASSWORD = "v05708";
            
            // ä¸»æ•°æ®å˜é‡
            let friendsData = [];
            
            // ==================== å¢å¼ºçš„æ•°æ®å­˜å‚¨å‡½æ•° ====================
            
            // æ ¹æ®åå­—è·å–å¤´åƒé¢œè‰²
            function getAvatarColor(name) {
                if (!name) return 'avatar-color-1';
                let sum = 0;
                for (let i = 0; i < name.length; i++) {
                    sum += name.charCodeAt(i);
                }
                return avatarColors[sum % avatarColors.length];
            }
            
            // è·å–åå­—é¦–å­—æ¯ï¼ˆä¸­æ–‡å–ç¬¬ä¸€ä¸ªå­—ï¼Œè‹±æ–‡å–é¦–å­—æ¯å¤§å†™ï¼‰
            function getInitials(name) {
                if (!name) return '?';
                // å¦‚æœæ˜¯ä¸­æ–‡ï¼Œå–ç¬¬ä¸€ä¸ªå­—
                if (/[\u4e00-\u9fa5]/.test(name)) {
                    return name.charAt(0);
                }
                // å¦‚æœæ˜¯è‹±æ–‡ï¼Œå–é¦–å­—æ¯å¤§å†™
                return name.charAt(0).toUpperCase();
            }
            
            // ç”Ÿæˆçº¯è‰²å¤´åƒHTML
            function generateSolidAvatar(name, size = 'small') {
                const colorClass = getAvatarColor(name);
                const initials = getInitials(name);
                
                if (size === 'large') {
                    return `<div class="friend-profile-img ${colorClass}">${initials}</div>`;
                } else {
                    return `<div class="friend-avatar ${colorClass}">${initials}</div>`;
                }
            }
            
            // ==================== ä¿®å¤ï¼šå¢å¼ºçš„æ•°æ®åŠ è½½å’Œä¿å­˜ ====================
            
            // æ£€æŸ¥å­˜å‚¨å¯ç”¨æ€§
            function isStorageAvailable() {
                try {
                    const testKey = '__storage_test__';
                    localStorage.setItem(testKey, testKey);
                    localStorage.removeItem(testKey);
                    return true;
                } catch (e) {
                    return false;
                }
            }
            
            // å¢å¼ºçš„æ•°æ®åŠ è½½å‡½æ•° - ä¿®å¤GitHub Pageså…¼å®¹æ€§
            function loadFriendsDataFromStorage() {
                console.log("å¼€å§‹ä»å­˜å‚¨åŠ è½½æ•°æ®...");
                
                // æ£€æŸ¥å­˜å‚¨æ˜¯å¦å¯ç”¨
                if (!isStorageAvailable()) {
                    console.error("localStorageä¸å¯ç”¨ï¼");
                    showNotification('æµè§ˆå™¨å­˜å‚¨ä¸å¯ç”¨ï¼Œæ•°æ®å°†ä¸ä¼šä¿å­˜', 'error');
                    return getDefaultData();
                }
                
                // å°è¯•ä»å¤šä¸ªå¯èƒ½çš„keyåŠ è½½æ•°æ®ï¼ˆå…¼å®¹æ—§ç‰ˆæœ¬ï¼‰
                const possibleKeys = [
                    STORAGE_KEY,
                    'friendsData',
                    've_space_friends_data',
                    've_space_8_data'
                ];
                
                let loadedData = null;
                
                for (const key of possibleKeys) {
                    try {
                        const stored = localStorage.getItem(key);
                        if (stored) {
                            const parsed = JSON.parse(stored);
                            if (Array.isArray(parsed)) {
                                console.log(`ä» ${key} åŠ è½½æ•°æ®æˆåŠŸï¼Œæ•°é‡: ${parsed.length}`);
                                loadedData = parsed;
                                break;
                            }
                        }
                    } catch (e) {
                        console.warn(`æ— æ³•ä» ${key} åŠ è½½æ•°æ®:`, e);
                    }
                }
                
                // æ£€æŸ¥ç‰ˆæœ¬å…¼å®¹æ€§
                const storedVersion = localStorage.getItem(VERSION_KEY);
                if (storedVersion && storedVersion !== DATA_VERSION) {
                    console.log(`ç‰ˆæœ¬ä¸åŒ¹é…: å­˜å‚¨ç‰ˆæœ¬ ${storedVersion}, å½“å‰ç‰ˆæœ¬ ${DATA_VERSION}`);
                    // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ ç‰ˆæœ¬è¿ç§»é€»è¾‘
                }
                
                // å¦‚æœæ²¡æœ‰æ‰¾åˆ°æ•°æ®ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®
                if (!loadedData || !Array.isArray(loadedData)) {
                    console.log("æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆæ•°æ®ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®");
                    loadedData = getDefaultData();
                    
                    // ç«‹å³ä¿å­˜é»˜è®¤æ•°æ®
                    setTimeout(() => {
                        saveFriendsDataToStorage(loadedData);
                    }, 100);
                }
                
                // ç¡®ä¿æ•°æ®å®Œæ•´æ€§
                loadedData = ensureDataIntegrity(loadedData);
                
                console.log("æœ€ç»ˆåŠ è½½çš„æ•°æ®:", loadedData);
                return loadedData;
            }
            
            // å¢å¼ºçš„æ•°æ®ä¿å­˜å‡½æ•° - ä¿®å¤GitHub Pageså…¼å®¹æ€§
            function saveFriendsDataToStorage(data) {
                console.log("å¼€å§‹ä¿å­˜æ•°æ®åˆ°å­˜å‚¨...");
                
                if (!isStorageAvailable()) {
                    console.error("æ— æ³•ä¿å­˜ï¼šlocalStorageä¸å¯ç”¨");
                    showNotification('æ— æ³•ä¿å­˜æ•°æ®ï¼Œæµè§ˆå™¨å­˜å‚¨ä¸å¯ç”¨', 'error');
                    return false;
                }
                
                try {
                    // ç¡®ä¿æ•°æ®å®Œæ•´æ€§
                    const cleanData = ensureDataIntegrity(data);
                    
                    // ä¿å­˜åˆ°ä¸»å­˜å‚¨
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(cleanData));
                    
                    // åŒæ—¶ä¿å­˜åˆ°å¤‡ä»½å­˜å‚¨ï¼ˆé˜²æ­¢ä¸»å­˜å‚¨æŸåï¼‰
                    localStorage.setItem(BACKUP_KEY, JSON.stringify(cleanData));
                    
                    // ä¿å­˜ç‰ˆæœ¬å·
                    localStorage.setItem(VERSION_KEY, DATA_VERSION);
                    
                    // ä¿å­˜æ—¶é—´æˆ³
                    localStorage.setItem('ve_space_last_saved', new Date().toISOString());
                    
                    console.log("æ•°æ®ä¿å­˜æˆåŠŸ:", cleanData);
                    
                    // æ›´æ–°æ•°æ®çŠ¶æ€æŒ‡ç¤ºå™¨
                    updateDataStatus(true);
                    
                    return true;
                } catch (error) {
                    console.error("ä¿å­˜æ•°æ®å¤±è´¥:", error);
                    
                    // å°è¯•ä½¿ç”¨æ›´å°çš„æ•°æ®å—ä¿å­˜
                    try {
                        const simpleData = data.map(friend => ({
                            id: friend.id,
                            name: friend.name,
                            adminMessage: friend.adminMessage,
                            avatarColor: friend.avatarColor,
                            photos: friend.photos || [],
                            messages: friend.messages || []
                        }));
                        
                        localStorage.setItem(STORAGE_KEY, JSON.stringify(simpleData));
                        console.log("ä½¿ç”¨ç®€åŒ–æ•°æ®ä¿å­˜æˆåŠŸ");
                        updateDataStatus(true);
                        return true;
                    } catch (e) {
                        console.error("ç®€åŒ–æ•°æ®ä¿å­˜ä¹Ÿå¤±è´¥:", e);
                        updateDataStatus(false);
                        showNotification('æ•°æ®ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨å­˜å‚¨', 'error');
                        return false;
                    }
                }
            }
            
            // ç¡®ä¿æ•°æ®å®Œæ•´æ€§
            function ensureDataIntegrity(data) {
                if (!Array.isArray(data)) {
                    console.error("æ•°æ®ä¸æ˜¯æ•°ç»„ï¼Œé‡ç½®ä¸ºé»˜è®¤æ•°æ®");
                    return getDefaultData();
                }
                
                return data.map(friend => {
                    // ç¡®ä¿æ¯ä¸ªå¥½å‹éƒ½æœ‰å¿…éœ€çš„å±æ€§
                    const cleanFriend = {
                        id: friend.id || Date.now(),
                        name: friend.name || 'æ— åå¥½å‹',
                        adminMessage: friend.adminMessage || "ğŸ¥¬æƒ³å¯¹ä½ è¯´ï¼šå¾ˆé«˜å…´è®¤è¯†ä½ ï¼",
                        avatarColor: friend.avatarColor || getAvatarColor(friend.name),
                        photos: Array.isArray(friend.photos) ? friend.photos : [],
                        messages: Array.isArray(friend.messages) ? friend.messages : [],
                        timeline: []
                    };
                    
                    // ç”Ÿæˆæ—¶é—´çº¿
                    updateFriendTimeline(cleanFriend);
                    
                    return cleanFriend;
                });
            }
            
            // è·å–é»˜è®¤æ•°æ®
            function getDefaultData() {
                return [
                    {
                        id: 1,
                        name: "å°å¯çˆ±",
                        adminMessage: "äº²çˆ±çš„å°å¯çˆ±ï¼Œè®¤è¯†ä½ æ˜¯æˆ‘æœ€å¼€å¿ƒçš„äº‹æƒ…ï¼æ¯æ¬¡å’Œä½ èŠå¤©éƒ½æ„Ÿè§‰ç‰¹åˆ«æ¸©æš–ï¼Œå¸Œæœ›æˆ‘ä»¬çš„å‹è°Šé•¿å­˜ï¼",
                        avatarColor: 'avatar-color-1',
                        photos: [
                            {url: "https://images.unsplash.com/photo-1529626455594-4ff0802cfb7e?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=600&q=80", time: "2023-10-10 14:30", type: "photo"},
                            {url: "https://images.unsplash.com/photo-1517841905240-472988babdf9?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=600&q=80", time: "2023-10-12 09:15", type: "photo"},
                            {url: "https://images.unsplash.com/photo-1519281682544-5f37c4b14c47?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=600&q=80", time: "2023-10-15 18:45", type: "photo"}
                        ],
                        messages: [
                            { sender: "ğŸ¥¬", content: "äº²çˆ±çš„å°å¯çˆ±ï¼Œè®¤è¯†ä½ æ˜¯æˆ‘æœ€å¼€å¿ƒçš„äº‹æƒ…ï¼æ¯æ¬¡å’Œä½ èŠå¤©éƒ½æ„Ÿè§‰ç‰¹åˆ«æ¸©æš–ï¼Œå¸Œæœ›æˆ‘ä»¬çš„å‹è°Šé•¿å­˜ï¼", time: "2023-10-01 12:00", type: "message" },
                            { sender: "ğŸ¥¬", content: "æœ€è¿‘å¤©æ°”è½¬å‡‰äº†ï¼Œè®°å¾—å¤šç©¿è¡£æœå“¦ï¼", time: "2023-10-16 09:15", type: "message" },
                            { sender: "å°å¯çˆ±", content: "ğŸ¥¬ï¼Œè°¢è°¢ä½ è¿™ä¹ˆæ¸©æš–çš„ç•™è¨€ï¼æˆ‘ä¹Ÿè¶…çº§å–œæ¬¢å’Œä½ åšæœ‹å‹ï¼", time: "2023-10-15 14:30", type: "message" },
                            { sender: "å°å¯çˆ±", content: "ä½ ä¹Ÿæ˜¯ï¼å‘¨æœ«æœ‰ç©ºä¸€èµ·å–å¥¶èŒ¶å—ï¼Ÿ", time: "2023-10-16 18:45", type: "message" }
                        ],
                        timeline: []
                    },
                    {
                        id: 2,
                        name: "é˜³å…‰",
                        adminMessage: "é˜³å…‰ï¼Œä½ å°±åƒä½ çš„åå­—ä¸€æ ·ï¼Œæ€»æ˜¯èƒ½å¸¦ç»™æˆ‘æ­£èƒ½é‡ï¼è°¢è°¢ä½ ä¸€ç›´ä»¥æ¥çš„æ”¯æŒå’Œé¼“åŠ±ï½",
                        avatarColor: 'avatar-color-2',
                        photos: [
                            {url: "https://images.unsplash.com/photo-1519058082700-08a0b56da9b4?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=600&q=80", time: "2023-10-05 11:20", type: "photo"},
                            {url: "https://images.unsplash.com/photo-1508214751196-bcfd4ca60f91?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=600&q=80", time: "2023-10-08 16:45", type: "photo"}
                        ],
                        messages: [
                            { sender: "ğŸ¥¬", content: "é˜³å…‰ï¼Œä½ å°±åƒä½ çš„åå­—ä¸€æ ·ï¼Œæ€»æ˜¯èƒ½å¸¦ç»™æˆ‘æ­£èƒ½é‡ï¼è°¢è°¢ä½ ä¸€ç›´ä»¥æ¥çš„æ”¯æŒå’Œé¼“åŠ±ï½", time: "2023-10-01 10:30", type: "message" },
                            { sender: "é˜³å…‰", content: "ğŸ¥¬ä½ å¤ªä¼šå¤¸äººäº†ï¼å’Œä½ åœ¨ä¸€èµ·æ€»æ˜¯å¾ˆå¼€å¿ƒï¼", time: "2023-10-10 11:20", type: "message" }
                        ],
                        timeline: []
                    }
                ];
            }
            
            // æ›´æ–°æ•°æ®çŠ¶æ€æŒ‡ç¤ºå™¨
            function updateDataStatus(success) {
                if (success) {
                    dataStatus.className = 'data-status online';
                    dataStatus.innerHTML = '<span>æ•°æ®å·²ä¿å­˜ âœ“</span>';
                    
                    // 3ç§’åæ¢å¤æ™®é€šçŠ¶æ€
                    setTimeout(() => {
                        dataStatus.innerHTML = '<span>æ•°æ®å·²ä¿å­˜</span>';
                    }, 3000);
                } else {
                    dataStatus.className = 'data-status offline';
                    dataStatus.innerHTML = '<span>æ•°æ®ä¿å­˜å¤±è´¥ âš </span>';
                }
            }
            
            // æ›´æ–°å¥½å‹æ—¶é—´çº¿
            function updateFriendTimeline(friend) {
                friend.timeline = [];
                
                // æ·»åŠ æ‰€æœ‰ç…§ç‰‡
                if (friend.photos && friend.photos.length > 0) {
                    friend.photos.forEach(photo => {
                        friend.timeline.push({
                            ...photo,
                            sender: "ğŸ¥¬",
                            type: "photo"
                        });
                    });
                }
                
                // æ·»åŠ æ‰€æœ‰ç•™è¨€
                if (friend.messages && friend.messages.length > 0) {
                    friend.messages.forEach(message => {
                        friend.timeline.push({
                            ...message,
                            type: "message"
                        });
                    });
                }
                
                // æŒ‰æ—¶é—´æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰é¢ï¼‰
                friend.timeline.sort((a, b) => {
                    try {
                        return new Date(b.time) - new Date(a.time);
                    } catch (e) {
                        return 0;
                    }
                });
            }
            
            // æ›´æ–°æ‰€æœ‰å¥½å‹çš„æ—¶é—´çº¿
            function updateAllFriendsTimeline() {
                friendsData.forEach(friend => {
                    updateFriendTimeline(friend);
                });
            }
            
            // ==================== æ•°æ®å¤‡ä»½/æ¢å¤åŠŸèƒ½ ====================
            
            // å¯¼å‡ºæ•°æ®åˆ°æ–‡ä»¶
            function exportDataToFile() {
                try {
                    const dataStr = JSON.stringify(friendsData, null, 2);
                    const dataBlob = new Blob([dataStr], {type: 'application/json'});
                    
                    const url = URL.createObjectURL(dataBlob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `ğŸ¥¬çš„å¥½å‹æ¡£æ¡ˆå¤‡ä»½_${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    
                    showNotification('æ•°æ®å¤‡ä»½æ–‡ä»¶å·²ç”Ÿæˆï¼Œè¯·ä¿å­˜åˆ°æœ¬åœ°', 'success');
                } catch (error) {
                    console.error('å¯¼å‡ºæ•°æ®å¤±è´¥:', error);
                    showNotification('å¯¼å‡ºæ•°æ®å¤±è´¥', 'error');
                }
            }
            
            // ä»æ–‡ä»¶å¯¼å…¥æ•°æ®
            function importDataFromFile(file) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        
                        if (!Array.isArray(importedData)) {
                            throw new Error('æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
                        }
                        
                        // éªŒè¯å¯¼å…¥çš„æ•°æ®
                        const validatedData = ensureDataIntegrity(importedData);
                        
                        // ç¡®è®¤æ˜¯å¦è¦†ç›–ç°æœ‰æ•°æ®
                        if (friendsData.length > 0) {
                            if (confirm(`å¯¼å…¥ ${validatedData.length} ä¸ªå¥½å‹æ¡£æ¡ˆå°†è¦†ç›–ç°æœ‰çš„ ${friendsData.length} ä¸ªæ¡£æ¡ˆã€‚ç¡®å®šè¦å¯¼å…¥å—ï¼Ÿ`)) {
                                friendsData = validatedData;
                                saveFriendsDataToStorage(friendsData);
                                loadFriendsList();
                                showNotification(`æˆåŠŸå¯¼å…¥ ${validatedData.length} ä¸ªå¥½å‹æ¡£æ¡ˆ`, 'success');
                                updateDataStats();
                                dataModal.classList.remove('active');
                            }
                        } else {
                            friendsData = validatedData;
                            saveFriendsDataToStorage(friendsData);
                            loadFriendsList();
                            showNotification(`æˆåŠŸå¯¼å…¥ ${validatedData.length} ä¸ªå¥½å‹æ¡£æ¡ˆ`, 'success');
                            updateDataStats();
                            dataModal.classList.remove('active');
                        }
                    } catch (error) {
                        console.error('å¯¼å…¥æ•°æ®å¤±è´¥:', error);
                        showNotification('å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®', 'error');
                    }
                };
                
                reader.readAsText(file);
            }
            
            // æ›´æ–°æ•°æ®ç»Ÿè®¡
            function updateDataStats() {
                friendsCountSpan.textContent = friendsData.length;
                
                let totalPhotos = 0;
                let totalMessages = 0;
                
                friendsData.forEach(friend => {
                    totalPhotos += friend.photos ? friend.photos.length : 0;
                    totalMessages += friend.messages ? friend.messages.length : 0;
                });
                
                photosCountTotalSpan.textContent = totalPhotos;
                messagesCountTotalSpan.textContent = totalMessages;
                
                const lastSaved = localStorage.getItem('ve_space_last_saved');
                if (lastSaved) {
                    const date = new Date(lastSaved);
                    lastUpdatedSpan.textContent = date.toLocaleString('zh-CN');
                }
            }
            
            // ==================== ä¸»ä¸šåŠ¡é€»è¾‘ ====================
            
            // è§†è§’åˆ‡æ¢
            adminBtn.addEventListener('click', () => {
                adminBtn.classList.add('active');
                userBtn.classList.remove('active');
                adminView.classList.add('active');
                userView.classList.remove('active');
                
                // é‡ç½®ç®¡ç†å‘˜ç™»å½•çŠ¶æ€
                adminContent.classList.add('hidden');
                passwordSection.classList.remove('hidden');
                adminPasswordInput.value = '';
            });
            
            userBtn.addEventListener('click', () => {
                userBtn.classList.add('active');
                adminBtn.classList.remove('active');
                userView.classList.add('active');
                adminView.classList.remove('active');
                
                // é‡ç½®ç”¨æˆ·æœç´¢
                resetUserSearch();
                currentFriend = null;
            });
            
            // ç®¡ç†å‘˜ç™»å½•
            loginBtn.addEventListener('click', () => {
                const password = adminPasswordInput.value;
                
                if (password === ADMIN_PASSWORD) {
                    passwordSection.classList.add('hidden');
                    adminContent.classList.remove('hidden');
                    showNotification('æ¬¢è¿å›æ¥ï¼ŒğŸ¥¬ï¼', 'success');
                    loadFriendsList();
                } else {
                    showNotification('å¯†ç ä¸å¯¹å“¦ï¼Œå†è¯•è¯•çœ‹ï¼', 'error');
                    adminPasswordInput.value = '';
                    adminPasswordInput.focus();
                }
            });
            
            // ç®¡ç†å‘˜è¿”å›ç™»å½•æŒ‰é’®
            adminBackBtn.addEventListener('click', () => {
                adminContent.classList.add('hidden');
                passwordSection.classList.remove('hidden');
                adminPasswordInput.value = '';
            });
            
            // ç”¨æˆ·è¿”å›æœç´¢æŒ‰é’®
            userBackBtn.addEventListener('click', () => {
                resetUserSearch();
                currentFriend = null;
            });
            
            // é‡ç½®ç”¨æˆ·æœç´¢ç•Œé¢
            function resetUserSearch() {
                userResult.innerHTML = `
                    <div class="no-data">
                        <i class="fas fa-heart"></i>
                        <p>è¾“å…¥ä½ çš„åå­—ï¼Œçœ‹çœ‹ğŸ¥¬ç»™ä½ ç•™äº†ä»€ä¹ˆè¯</p>
                    </div>
                `;
                timelineSection.innerHTML = `
                    <div class="no-data">
                        <i class="fas fa-clock"></i>
                        <p>æ‰¾åˆ°ä½ çš„æ¡£æ¡ˆåï¼Œå¯ä»¥åœ¨è¿™é‡ŒæŸ¥çœ‹ğŸ¥¬ä¸ºä½ è®°å½•çš„æ—¶å…‰</p>
                    </div>
                `;
                newMessageSection.classList.add('hidden');
                userNameInput.value = '';
                userBackBtn.classList.add('hidden');
            }
            
            // å¤šç…§ç‰‡ä¸Šä¼ åŠŸèƒ½ï¼ˆåˆ›å»ºæ–°æ¡£æ¡ˆï¼‰
            photosUpload.addEventListener('click', () => {
                photosInput.click();
            });
            
            photosInput.addEventListener('change', (e) => {
                const files = Array.from(e.target.files);
                
                if (files.length === 0) return;
                
                // é™åˆ¶æœ€å¤šä¸Šä¼ 9å¼ ç…§ç‰‡
                if (selectedPhotos.length + files.length > 9) {
                    showNotification('æœ€å¤šåªèƒ½ä¸Šä¼ 9å¼ ç…§ç‰‡å“¦ï¼', 'error');
                    return;
                }
                
                files.forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        // ä¸ºæ¯å¼ ç…§ç‰‡ç”Ÿæˆå”¯ä¸€IDå’Œæ—¶é—´æˆ³
                        const photoId = Date.now() + Math.random();
                        const uploadTime = new Date().toLocaleString('zh-CN', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                        }).replace(/\//g, '-');
                        
                        selectedPhotos.push({
                            id: photoId,
                            url: event.target.result,
                            time: uploadTime,
                            type: 'photo'
                        });
                        
                        updatePhotosPreview();
                    };
                    reader.readAsDataURL(file);
                });
                
                // é‡ç½®æ–‡ä»¶è¾“å…¥ï¼Œä»¥ä¾¿å¯ä»¥å†æ¬¡é€‰æ‹©ç›¸åŒæ–‡ä»¶
                photosInput.value = '';
            });
            
            // æ›´æ–°ç…§ç‰‡é¢„è§ˆï¼ˆåˆ›å»ºæ–°æ¡£æ¡ˆï¼‰
            function updatePhotosPreview() {
                photosPreview.innerHTML = '';
                photosCount.textContent = selectedPhotos.length;
                
                if (selectedPhotos.length === 0) {
                    photosUpload.style.display = 'block';
                    return;
                }
                
                photosUpload.style.display = 'none';
                
                selectedPhotos.forEach((photo, index) => {
                    const photoItem = document.createElement('div');
                    photoItem.className = 'photo-item';
                    photoItem.innerHTML = `
                        <img src="${photo.url}" alt="é¢„è§ˆç…§ç‰‡ ${index + 1}">
                        <div class="photo-info">
                            <div>ç…§ç‰‡ ${index + 1}</div>
                            <div class="photo-time">${photo.time}</div>
                        </div>
                        <button class="remove-photo" data-id="${photo.id}">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    
                    photosPreview.appendChild(photoItem);
                });
                
                // æ·»åŠ åˆ é™¤ç…§ç‰‡äº‹ä»¶
                document.querySelectorAll('.remove-photo').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const photoId = e.currentTarget.getAttribute('data-id');
                        selectedPhotos = selectedPhotos.filter(photo => photo.id != photoId);
                        updatePhotosPreview();
                    });
                });
            }
            
            // åˆ›å»ºå¥½å‹æ¡£æ¡ˆ - GitHub Pagesä¼˜åŒ–ç‰ˆ
            friendForm.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const name = friendNameInput.value.trim();
                const adminMessage = adminMessageInput.value.trim();
                
                if (!name) {
                    showNotification('è¯·è¾“å…¥å¥½å‹çš„åå­—å“¦ï¼', 'error');
                    return;
                }
                
                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨åŒåå¥½å‹
                const existingFriend = friendsData.find(friend => friend.name === name);
                if (existingFriend) {
                    showNotification('å·²ç»æœ‰åŒåå¥½å‹çš„æ¡£æ¡ˆå•¦ï¼æ¢ä¸ªåå­—è¯•è¯•ï¼Ÿ', 'error');
                    return;
                }
                
                // ç”Ÿæˆæ–°å¥½å‹ID
                const newId = friendsData.length > 0 ? Math.max(...friendsData.map(f => f.id)) + 1 : 1;
                
                // è·å–å½“å‰æ—¶é—´
                const now = new Date();
                const timeString = now.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                }).replace(/\//g, '-');
                
                // ç”Ÿæˆå¤´åƒé¢œè‰²
                const avatarColor = getAvatarColor(name);
                
                // åˆ›å»ºæ–°å¥½å‹æ¡£æ¡ˆ
                const newFriend = {
                    id: newId,
                    name: name,
                    adminMessage: adminMessage || "ğŸ¥¬æƒ³å¯¹ä½ è¯´ï¼šå¾ˆé«˜å…´è®¤è¯†ä½ ï¼",
                    avatarColor: avatarColor,
                    photos: [],
                    messages: [],
                    timeline: []
                };
                
                // æ·»åŠ ç…§ç‰‡
                selectedPhotos.forEach(photo => {
                    const photoObj = {
                        url: photo.url,
                        time: photo.time,
                        type: 'photo'
                    };
                    newFriend.photos.push(photoObj);
                });
                
                // æ·»åŠ åˆå§‹ç•™è¨€
                const initialMessage = {
                    sender: "ğŸ¥¬",
                    content: adminMessage || "ğŸ¥¬æƒ³å¯¹ä½ è¯´ï¼šå¾ˆé«˜å…´è®¤è¯†ä½ ï¼",
                    time: timeString,
                    type: "message"
                };
                newFriend.messages.push(initialMessage);
                
                // æ·»åŠ åˆ°æ•°æ®æ•°ç»„
                friendsData.push(newFriend);
                
                // æ›´æ–°æ—¶é—´çº¿
                updateFriendTimeline(newFriend);
                
                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ - ä½¿ç”¨å¢å¼ºçš„ä¿å­˜å‡½æ•°
                const saveSuccess = saveFriendsDataToStorage(friendsData);
                
                if (saveSuccess) {
                    // é‡ç½®è¡¨å•
                    friendForm.reset();
                    selectedPhotos = [];
                    updatePhotosPreview();
                    photosUpload.style.display = 'block';
                    
                    // ç«‹å³é‡æ–°åŠ è½½å¥½å‹åˆ—è¡¨
                    setTimeout(() => {
                        loadFriendsList();
                        showNotification(`å¥½å‹ "${name}" çš„æ¡£æ¡ˆåˆ›å»ºæˆåŠŸï¼ğŸ¥¬`, 'success');
                    }, 100);
                } else {
                    // å¦‚æœä¿å­˜å¤±è´¥ï¼Œç§»é™¤åˆšåˆšæ·»åŠ çš„å¥½å‹
                    friendsData = friendsData.filter(f => f.id !== newId);
                    showNotification('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•ï¼', 'error');
                }
            });
            
            // åŠ è½½å¥½å‹åˆ—è¡¨
            function loadFriendsList() {
                console.log("å¼€å§‹åŠ è½½å¥½å‹åˆ—è¡¨...");
                
                // ç¡®ä¿ä½¿ç”¨æœ€æ–°çš„æ•°æ®
                friendsData = loadFriendsDataFromStorage();
                console.log("åŠ è½½åçš„æ•°æ®:", friendsData);
                
                if (friendsData.length === 0) {
                    friendList.innerHTML = `
                        <div class="no-data">
                            <i class="fas fa-users"></i>
                            <p>è¿˜æ²¡æœ‰å¥½å‹æ¡£æ¡ˆï¼Œå¿«ä¸ºä½ çš„æœ‹å‹åˆ›å»ºä¸€ä¸ªå§ï¼</p>
                        </div>
                    `;
                    return;
                }
                
                // æ¸…ç©ºå½“å‰åˆ—è¡¨
                friendList.innerHTML = '';
                
                // æŒ‰IDæ’åºï¼Œæœ€æ–°çš„åœ¨å‰é¢
                const sortedFriends = [...friendsData].sort((a, b) => b.id - a.id);
                
                sortedFriends.forEach(friend => {
                    // ç”Ÿæˆçº¯è‰²å¤´åƒHTML
                    const avatarHtml = generateSolidAvatar(friend.name, 'small');
                    
                    const friendItem = document.createElement('div');
                    friendItem.className = 'friend-item';
                    friendItem.innerHTML = `
                        ${avatarHtml}
                        <div class="friend-info">
                            <h4>${friend.name}</h4>
                            <p>${friend.adminMessage ? (friend.adminMessage.substring(0, 60) + (friend.adminMessage.length > 60 ? '...' : '')) : 'ğŸ¥¬çš„æš–å¿ƒç•™è¨€'}</p>
                            <p style="font-size: 0.9rem; color: var(--accent-color); margin-top: 5px;">
                                <i class="fas fa-images"></i> ${friend.photos ? friend.photos.length : 0} å¼ ç…§ç‰‡ Â· 
                                <i class="fas fa-comments"></i> ${friend.messages ? friend.messages.length : 0} æ¡ç•™è¨€
                            </p>
                        </div>
                        <div class="friend-actions">
                            <button class="action-btn view-friend-btn" data-id="${friend.id}">
                                <i class="fas fa-heart"></i>
                            </button>
                            <button class="action-btn manage-friend-btn" data-id="${friend.id}">
                                <i class="fas fa-cog"></i>
                            </button>
                            <button class="action-btn delete-friend-btn" data-id="${friend.id}">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    `;
                    
                    friendList.appendChild(friendItem);
                });
                
                // æ·»åŠ æŸ¥çœ‹å’Œåˆ é™¤äº‹ä»¶ç›‘å¬
                document.querySelectorAll('.view-friend-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const friendId = parseInt(e.currentTarget.getAttribute('data-id'));
                        viewFriend(friendId);
                    });
                });
                
                // æ·»åŠ ç®¡ç†äº‹ä»¶ç›‘å¬
                document.querySelectorAll('.manage-friend-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const friendId = parseInt(e.currentTarget.getAttribute('data-id'));
                        openManageModal(friendId);
                    });
                });
                
                document.querySelectorAll('.delete-friend-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const friendId = parseInt(e.currentTarget.getAttribute('data-id'));
                        deleteFriend(friendId);
                    });
                });
            }
            
            // æ‰“å¼€ç®¡ç†æ¨¡æ€æ¡†
            function openManageModal(friendId) {
                const friend = friendsData.find(f => f.id === friendId);
                if (!friend) return;
                
                managingFriend = friend;
                
                // å¡«å……æ¨¡æ€æ¡†å†…å®¹
                manageFriendNameInput.value = friend.name;
                manageAdminMessageInput.value = friend.adminMessage;
                manageNewMessageInput.value = '';
                
                // æ˜¾ç¤ºå·²æœ‰ç…§ç‰‡
                displayExistingPhotos(friend);
                
                // é‡ç½®ç®¡ç†ç…§ç‰‡ä¸Šä¼ åŒºåŸŸ
                selectedManagePhotos = [];
                updateManagePhotosPreview();
                
                // æ˜¾ç¤ºæ¨¡æ€æ¡†
                manageFriendModal.classList.add('active');
            }
            
            // æ˜¾ç¤ºå·²æœ‰ç…§ç‰‡
            function displayExistingPhotos(friend) {
                existingPhotosContainer.innerHTML = '';
                
                if (!friend.photos || friend.photos.length === 0) {
                    existingPhotosContainer.innerHTML = `
                        <div class="no-data" style="padding: 20px; grid-column: 1 / -1;">
                            <i class="fas fa-images"></i>
                            <p>è¿˜æ²¡æœ‰ä¸Šä¼ ç…§ç‰‡</p>
                        </div>
                    `;
                    return;
                }
                
                friend.photos.forEach((photo, index) => {
                    const photoItem = document.createElement('div');
                    photoItem.className = 'existing-photo-item';
                    photoItem.innerHTML = `
                        <img src="${photo.url}" alt="å·²æœ‰ç…§ç‰‡ ${index + 1}">
                        <div class="existing-photo-time">${photo.time}</div>
                        <button class="remove-existing-photo" data-index="${index}">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    
                    existingPhotosContainer.appendChild(photoItem);
                });
                
                // æ·»åŠ åˆ é™¤å·²æœ‰ç…§ç‰‡äº‹ä»¶
                document.querySelectorAll('.remove-existing-photo').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const photoIndex = parseInt(e.currentTarget.getAttribute('data-index'));
                        if (confirm('ç¡®å®šè¦åˆ é™¤è¿™å¼ ç…§ç‰‡å—ï¼Ÿ')) {
                            managingFriend.photos.splice(photoIndex, 1);
                            // æ›´æ–°æ—¶é—´çº¿
                            updateFriendTimeline(managingFriend);
                            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                            saveFriendsDataToStorage(friendsData);
                            // é‡æ–°æ˜¾ç¤ºå·²æœ‰ç…§ç‰‡
                            displayExistingPhotos(managingFriend);
                            // é‡æ–°åŠ è½½å¥½å‹åˆ—è¡¨
                            loadFriendsList();
                            showNotification('ç…§ç‰‡åˆ é™¤æˆåŠŸï¼', 'info');
                        }
                    });
                });
            }
            
            // å¤šç…§ç‰‡ä¸Šä¼ åŠŸèƒ½ï¼ˆç®¡ç†æ¡£æ¡ˆï¼‰
            managePhotosUpload.addEventListener('click', () => {
                managePhotosInput.click();
            });
            
            managePhotosInput.addEventListener('change', (e) => {
                const files = Array.from(e.target.files);
                
                if (files.length === 0) return;
                
                // é™åˆ¶æœ€å¤šä¸Šä¼ 9å¼ ç…§ç‰‡
                if (selectedManagePhotos.length + files.length > 9) {
                    showNotification('æœ€å¤šåªèƒ½ä¸Šä¼ 9å¼ ç…§ç‰‡å“¦ï¼', 'error');
                    return;
                }
                
                files.forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        // ä¸ºæ¯å¼ ç…§ç‰‡ç”Ÿæˆå”¯ä¸€IDå’Œæ—¶é—´æˆ³
                        const photoId = Date.now() + Math.random();
                        const uploadTime = new Date().toLocaleString('zh-CN', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                        }).replace(/\//g, '-');
                        
                        selectedManagePhotos.push({
                            id: photoId,
                            url: event.target.result,
                            time: uploadTime,
                            type: 'photo'
                        });
                        
                        updateManagePhotosPreview();
                    };
                    reader.readAsDataURL(file);
                });
                
                // é‡ç½®æ–‡ä»¶è¾“å…¥ï¼Œä»¥ä¾¿å¯ä»¥å†æ¬¡é€‰æ‹©ç›¸åŒæ–‡ä»¶
                managePhotosInput.value = '';
            });
            
            // æ›´æ–°ç®¡ç†ç…§ç‰‡é¢„è§ˆ
            function updateManagePhotosPreview() {
                managePhotosPreview.innerHTML = '';
                managePhotosCount.textContent = selectedManagePhotos.length;
                
                if (selectedManagePhotos.length === 0) {
                    managePhotosUpload.style.display = 'block';
                    return;
                }
                
                managePhotosUpload.style.display = 'none';
                
                selectedManagePhotos.forEach((photo, index) => {
                    const photoItem = document.createElement('div');
                    photoItem.className = 'photo-item';
                    photoItem.innerHTML = `
                        <img src="${photo.url}" alt="æ–°ç…§ç‰‡ ${index + 1}">
                        <div class="photo-info">
                            <div>æ–°ç…§ç‰‡ ${index + 1}</div>
                            <div class="photo-time">${photo.time}</div>
                        </div>
                        <button class="remove-photo" data-id="${photo.id}">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    
                    managePhotosPreview.appendChild(photoItem);
                });
                
                // æ·»åŠ åˆ é™¤ç…§ç‰‡äº‹ä»¶
                document.querySelectorAll('#manage-photos-preview .remove-photo').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const photoId = e.currentTarget.getAttribute('data-id');
                        selectedManagePhotos = selectedManagePhotos.filter(photo => photo.id != photoId);
                        updateManagePhotosPreview();
                    });
                });
            }
            
            // ä¿å­˜ç®¡ç†æ›´æ”¹
            saveManageBtn.addEventListener('click', () => {
                if (!managingFriend) return;
                
                // æ›´æ–°ç®¡ç†å‘˜ç•™è¨€
                managingFriend.adminMessage = manageAdminMessageInput.value.trim() || managingFriend.adminMessage;
                
                // æ·»åŠ æ–°ç…§ç‰‡
                if (selectedManagePhotos.length > 0) {
                    selectedManagePhotos.forEach(photo => {
                        managingFriend.photos.push({
                            url: photo.url,
                            time: photo.time,
                            type: 'photo'
                        });
                    });
                }
                
                // æ·»åŠ æ–°ç•™è¨€ï¼ˆå¦‚æœæœ‰ï¼‰
                const newMessageContent = manageNewMessageInput.value.trim();
                if (newMessageContent) {
                    const now = new Date();
                    const timeString = now.toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    }).replace(/\//g, '-');
                    
                    const newMessage = {
                        sender: "ğŸ¥¬",
                        content: newMessageContent,
                        time: timeString,
                        type: 'message'
                    };
                    
                    managingFriend.messages.push(newMessage);
                }
                
                // æ›´æ–°æ—¶é—´çº¿
                updateFriendTimeline(managingFriend);
                
                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                const saveSuccess = saveFriendsDataToStorage(friendsData);
                
                if (saveSuccess) {
                    // é‡ç½®ç®¡ç†ç…§ç‰‡ä¸Šä¼ åŒºåŸŸ
                    selectedManagePhotos = [];
                    updateManagePhotosPreview();
                    manageNewMessageInput.value = '';
                    
                    // é‡æ–°æ˜¾ç¤ºå·²æœ‰ç…§ç‰‡
                    displayExistingPhotos(managingFriend);
                    
                    // é‡æ–°åŠ è½½å¥½å‹åˆ—è¡¨
                    setTimeout(() => {
                        loadFriendsList();
                    }, 100);
                    
                    // å…³é—­æ¨¡æ€æ¡†
                    manageFriendModal.classList.remove('active');
                    
                    showNotification(`å¥½å‹ "${managingFriend.name}" çš„æ¡£æ¡ˆå·²æ›´æ–°æˆåŠŸï¼ğŸ¥¬`, 'success');
                } else {
                    showNotification('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•ï¼', 'error');
                }
            });
            
            // ä»…æ·»åŠ ç•™è¨€æŒ‰é’®
            addMessageBtn.addEventListener('click', () => {
                if (!managingFriend) return;
                
                const newMessageContent = manageNewMessageInput.value.trim();
                if (!newMessageContent) {
                    showNotification('è¯·è¾“å…¥ç•™è¨€å†…å®¹ï¼', 'error');
                    return;
                }
                
                const now = new Date();
                const timeString = now.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                }).replace(/\//g, '-');
                
                const newMessage = {
                    sender: "ğŸ¥¬",
                    content: newMessageContent,
                    time: timeString,
                    type: 'message'
                };
                
                managingFriend.messages.push(newMessage);
                
                // æ›´æ–°æ—¶é—´çº¿
                updateFriendTimeline(managingFriend);
                
                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                const saveSuccess = saveFriendsDataToStorage(friendsData);
                
                if (saveSuccess) {
                    // é‡ç½®ç•™è¨€è¾“å…¥æ¡†
                    manageNewMessageInput.value = '';
                    
                    // é‡æ–°æ˜¾ç¤ºå·²æœ‰ç…§ç‰‡
                    displayExistingPhotos(managingFriend);
                    
                    // é‡æ–°åŠ è½½å¥½å‹åˆ—è¡¨
                    setTimeout(() => {
                        loadFriendsList();
                    }, 100);
                    
                    showNotification(`å·²ä¸º "${managingFriend.name}" æ·»åŠ æ–°ç•™è¨€æˆåŠŸï¼ğŸ¥¬`, 'success');
                } else {
                    showNotification('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•ï¼', 'error');
                }
            });
            
            // å…³é—­ç®¡ç†æ¨¡æ€æ¡†
            closeManageModalBtn.addEventListener('click', () => {
                manageFriendModal.classList.remove('active');
            });
            
            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            manageFriendModal.addEventListener('click', (e) => {
                if (e.target === manageFriendModal) {
                    manageFriendModal.classList.remove('active');
                }
            });
            
            // æŸ¥çœ‹å¥½å‹æ¡£æ¡ˆ
            function viewFriend(friendId) {
                const friend = friendsData.find(f => f.id === friendId);
                if (!friend) return;
                
                // åˆ‡æ¢åˆ°ç”¨æˆ·è§†è§’
                userBtn.click();
                
                // è®¾ç½®æœç´¢æ¡†
                userNameInput.value = friend.name;
                
                // æ˜¾ç¤ºå¥½å‹æ¡£æ¡ˆ
                displayFriendProfile(friend);
            }
            
            // åˆ é™¤å¥½å‹æ¡£æ¡ˆ
            function deleteFriend(friendId) {
                const friend = friendsData.find(f => f.id === friendId);
                if (!friend) return;
                
                if (confirm(`ç¡®å®šè¦åˆ é™¤å¥½å‹ "${friend.name}" çš„æ¡£æ¡ˆå—ï¼Ÿè¿™å°†ä¼šåˆ é™¤æ‰€æœ‰ç…§ç‰‡å’Œç•™è¨€è®°å½•ã€‚`)) {
                    friendsData = friendsData.filter(f => f.id !== friendId);
                    
                    // æ›´æ–°æ—¶é—´çº¿
                    updateAllFriendsTimeline();
                    
                    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                    const saveSuccess = saveFriendsDataToStorage(friendsData);
                    
                    if (saveSuccess) {
                        // ç«‹å³é‡æ–°åŠ è½½å¥½å‹åˆ—è¡¨
                        setTimeout(() => {
                            loadFriendsList();
                            showNotification(`å¥½å‹ "${friend.name}" çš„æ¡£æ¡ˆå·²åˆ é™¤æˆåŠŸï¼`, 'info');
                        }, 100);
                    } else {
                        showNotification('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•ï¼', 'error');
                    }
                }
            }
            
            // æ—¶é—´çº¿è¿‡æ»¤å™¨
            timelineFilter.addEventListener('click', (e) => {
                if (e.target.classList.contains('filter-btn')) {
                    // æ›´æ–°æ´»åŠ¨æŒ‰é’®
                    document.querySelectorAll('.filter-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    e.target.classList.add('active');
                    
                    // æ›´æ–°è¿‡æ»¤å™¨
                    currentFilter = e.target.getAttribute('data-filter');
                    
                    // é‡æ–°æ¸²æŸ“æ—¶é—´çº¿
                    if (currentFriend) {
                        displayTimeline(currentFriend);
                    }
                }
            });
            
            // ç”¨æˆ·æœç´¢å¥½å‹æ¡£æ¡ˆ
            searchBtn.addEventListener('click', searchFriend);
            
            userNameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    searchFriend();
                }
            });
            
            function searchFriend() {
                const name = userNameInput.value.trim();
                
                if (!name) {
                    showNotification('è¯·è¾“å…¥ä½ çš„åå­—å“¦ï¼', 'error');
                    return;
                }
                
                // ç¡®ä¿ä½¿ç”¨æœ€æ–°çš„æ•°æ®
                friendsData = loadFriendsDataFromStorage();
                
                const friend = friendsData.find(f => f.name.toLowerCase() === name.toLowerCase());
                
                if (friend) {
                    displayFriendProfile(friend);
                } else {
                    userResult.innerHTML = `
                        <div class="no-data">
                            <i class="fas fa-user-slash"></i>
                            <p style="color: #FF7A7A;">è¯·ç§èŠğŸ¥¬å¹¶è€å¿ƒç­‰å¾…ä¸€ä¼šå“¦~</p>
                            <p style="margin-top: 10px; font-size: 1rem;">ğŸ¥¬è¿˜æ²¡æœ‰åˆ›å»ºä½ çš„æ¡£æ¡ˆ</p>
                        </div>
                    `;
                    
                    timelineSection.innerHTML = `
                        <div class="no-data">
                            <i class="fas fa-clock"></i>
                            <p>è¿˜æ²¡æœ‰æ—¶é—´çº¿è®°å½•</p>
                        </div>
                    `;
                    
                    newMessageSection.classList.add('hidden');
                    userBackBtn.classList.remove('hidden');
                    currentFriend = null;
                }
            }
            
            // æ˜¾ç¤ºå¥½å‹æ¡£æ¡ˆ
            function displayFriendProfile(friend) {
                currentFriend = friend;
                
                // ç”Ÿæˆçº¯è‰²å¤´åƒHTMLï¼ˆå¤§å°ºå¯¸ï¼‰
                const avatarHtml = generateSolidAvatar(friend.name, 'large');
                
                // æ˜¾ç¤ºå¥½å‹ä¿¡æ¯ï¼ˆä½¿ç”¨çº¯è‰²å¤´åƒï¼‰
                userResult.innerHTML = `
                    <div class="friend-profile">
                        <div class="friend-avatar-container">
                            ${avatarHtml}
                        </div>
                        <h3>${friend.name}</h3>
                        <p>æ¬¢è¿æ¥åˆ°ä½ çš„ä¸“å±æ¡£æ¡ˆï¼ğŸ¥¬ä¸ºä½ è®°å½•äº†ä¸€äº›ç¾å¥½æ—¶åˆ»ï½</p>
                    </div>
                `;
                
                // æ˜¾ç¤ºæ—¶é—´çº¿
                displayTimeline(friend);
                
                // æ˜¾ç¤ºç•™è¨€è¾“å…¥æ¡†
                newMessageSection.classList.remove('hidden');
                userMessageInput.value = '';
                userMessageInput.focus();
                
                // æ˜¾ç¤ºè¿”å›æŒ‰é’®
                userBackBtn.classList.remove('hidden');
            }
            
            // æ˜¾ç¤ºæ—¶é—´çº¿
            function displayTimeline(friend) {
                // ç¡®ä¿æ—¶é—´çº¿æ˜¯æœ€æ–°çš„
                updateFriendTimeline(friend);
                
                // è¿‡æ»¤æ—¶é—´çº¿é¡¹ç›®
                let filteredTimeline = friend.timeline;
                if (currentFilter === 'message') {
                    filteredTimeline = friend.timeline.filter(item => item.type === 'message');
                } else if (currentFilter === 'photo') {
                    filteredTimeline = friend.timeline.filter(item => item.type === 'photo');
                }
                
                if (!filteredTimeline || filteredTimeline.length === 0) {
                    timelineSection.innerHTML = `
                        <div class="no-data">
                            <i class="fas fa-clock"></i>
                            <p>è¿˜æ²¡æœ‰æ—¶é—´çº¿è®°å½•</p>
                        </div>
                    `;
                    return;
                }
                
                timelineSection.innerHTML = '<div class="timeline">';
                
                filteredTimeline.forEach(item => {
                    const timelineItem = document.createElement('div');
                    timelineItem.className = 'timeline-item';
                    
                    if (item.type === 'message') {
                        timelineItem.innerHTML = `
                            <div class="timeline-icon">
                                <i class="fas fa-comment"></i>
                            </div>
                            <div class="timeline-content">
                                <div class="timeline-header">
                                    <span class="timeline-sender">${item.sender}</span>
                                    <span class="timeline-time">${item.time}</span>
                                </div>
                                <div class="timeline-message">${item.content}</div>
                            </div>
                        `;
                    } else if (item.type === 'photo') {
                        timelineItem.innerHTML = `
                            <div class="timeline-icon">
                                <i class="fas fa-image"></i>
                            </div>
                            <div class="timeline-content">
                                <div class="timeline-header">
                                    <span class="timeline-sender">ğŸ¥¬ä¸Šä¼ çš„ç…§ç‰‡</span>
                                    <span class="timeline-time">${item.time}</span>
                                </div>
                                <div class="timeline-photos">
                                    <div class="timeline-photo">
                                        <img src="${item.url}" alt="ğŸ¥¬ä¸Šä¼ çš„ç…§ç‰‡">
                                        <div class="timeline-photo-time">${item.time}</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    timelineSection.querySelector('.timeline').appendChild(timelineItem);
                });
                
                timelineSection.innerHTML += '</div>';
            }
            
            // å‘é€ç•™è¨€ï¼ˆç”¨æˆ·ï¼‰
            sendMessageBtn.addEventListener('click', () => {
                if (!currentFriend) {
                    showNotification('è¯·å…ˆæŸ¥æ‰¾ä½ çš„æ¡£æ¡ˆï¼', 'error');
                    return;
                }
                
                const message = userMessageInput.value.trim();
                
                if (!message) {
                    showNotification('è¯·è¾“å…¥ç•™è¨€å†…å®¹å“¦ï¼', 'error');
                    return;
                }
                
                // è·å–å½“å‰æ—¶é—´
                const now = new Date();
                const timeString = now.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                }).replace(/\//g, '-');
                
                // åˆ›å»ºç•™è¨€å¯¹è±¡
                const newMessage = {
                    sender: currentFriend.name,
                    content: message,
                    time: timeString,
                    type: 'message'
                };
                
                // ç¡®ä¿æ¶ˆæ¯æ•°ç»„å­˜åœ¨
                if (!currentFriend.messages) currentFriend.messages = [];
                
                // æ·»åŠ åˆ°æ¶ˆæ¯æ•°ç»„
                currentFriend.messages.push(newMessage);
                
                // æ›´æ–°æ—¶é—´çº¿
                updateFriendTimeline(currentFriend);
                
                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                const saveSuccess = saveFriendsDataToStorage(friendsData);
                
                if (saveSuccess) {
                    // é‡æ–°æ˜¾ç¤ºæ—¶é—´çº¿
                    displayTimeline(currentFriend);
                    
                    // æ¸…ç©ºè¾“å…¥æ¡†
                    userMessageInput.value = '';
                    
                    showNotification('ç•™è¨€å‘é€æˆåŠŸï¼ğŸ¥¬ä¼šå¾ˆå¿«å›å¤ä½ çš„ï¼', 'success');
                    
                    // è‡ªåŠ¨æ·»åŠ ä¸€æ¡ğŸ¥¬å›å¤ï¼ˆæ¨¡æ‹Ÿï¼‰
                    setTimeout(() => {
                        // éšæœºé€‰æ‹©ä¸€æ¡å›å¤
                        const replies = [
                            "æ”¶åˆ°ä½ çš„ç•™è¨€å•¦ï¼Œå¥½å¼€å¿ƒï¼",
                            "è°¢è°¢ä½ çš„ç•™è¨€ï¼Œæˆ‘ä¼šä¸€ç›´çæƒœæˆ‘ä»¬çš„å‹è°Šï¼",
                            "çœ‹åˆ°ä½ çš„ç•™è¨€å¿ƒé‡Œæš–æš–çš„ï¼",
                            "è°¢è°¢å…³å¿ƒï¼Œä½ ä¹Ÿè¦ç…§é¡¾å¥½è‡ªå·±å“¦ï¼",
                            "å·²æ”¶åˆ°ï¼ŒæœŸå¾…ä¸‹æ¬¡è§é¢ï¼",
                            "ä½ çš„ç•™è¨€è®©æˆ‘ä»Šå¤©çš„å¿ƒæƒ…éƒ½å˜å¥½äº†ï¼",
                            "å‹è°Šä¸‡å²ï¼ğŸ¥¬æ°¸è¿œæ˜¯ä½ çš„æœ‹å‹ï¼"
                        ];
                        
                        const randomReply = replies[Math.floor(Math.random() * replies.length)];
                        
                        // åˆ›å»ºå›å¤å¯¹è±¡
                        const replyMessage = {
                            sender: "ğŸ¥¬",
                            content: randomReply,
                            time: new Date(now.getTime() + 60000).toLocaleString('zh-CN', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit'
                            }).replace(/\//g, '-'),
                            type: 'message'
                        };
                        
                        // æ·»åŠ ğŸ¥¬å›å¤
                        currentFriend.messages.push(replyMessage);
                        
                        // æ›´æ–°æ—¶é—´çº¿
                        updateFriendTimeline(currentFriend);
                        
                        // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                        saveFriendsDataToStorage(friendsData);
                        
                        // é‡æ–°æ˜¾ç¤ºæ—¶é—´çº¿
                        displayTimeline(currentFriend);
                        
                        showNotification('ğŸ¥¬å›å¤äº†ä½ çš„ç•™è¨€ï¼', 'info');
                    }, 2000);
                } else {
                    showNotification('å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•ï¼', 'error');
                }
            });
            
            // æ˜¾ç¤ºé€šçŸ¥
            function showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.innerHTML = `<span>${message}</span>`;
                
                notificationContainer.appendChild(notification);
                
                // 3ç§’åè‡ªåŠ¨ç§»é™¤
                setTimeout(() => {
                    notification.style.animation = 'slideIn 0.5s ease reverse';
                    setTimeout(() => {
                        notification.remove();
                    }, 500);
                }, 3000);
            }
            
            // ==================== æ•°æ®ç®¡ç†åŠŸèƒ½ ====================
            
            // å¤‡ä»½æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            backupBtn.addEventListener('click', () => {
                dataModal.classList.add('active');
                updateDataStats();
            });
            
            // å¯¼å‡ºæ•°æ®æŒ‰é’®
            exportDataBtn.addEventListener('click', exportDataToFile);
            
            // å¯¼å…¥æ•°æ®æŒ‰é’®
            importDataBtn.addEventListener('click', () => {
                if (importDataFile.files.length > 0) {
                    importDataFromFile(importDataFile.files[0]);
                } else {
                    showNotification('è¯·å…ˆé€‰æ‹©å¤‡ä»½æ–‡ä»¶', 'error');
                }
            });
            
            // å…³é—­æ•°æ®æ¨¡æ€æ¡†
            closeDataModalBtn.addEventListener('click', () => {
                dataModal.classList.remove('active');
            });
            
            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            dataModal.addEventListener('click', (e) => {
                if (e.target === dataModal) {
                    dataModal.classList.remove('active');
                }
            });
            
            // ==================== é¡µé¢åŠ è½½åˆå§‹åŒ– ====================
            
            // åˆå§‹åŒ–é¡µé¢
            function init() {
                console.log("åˆå§‹åŒ–é¡µé¢...");
                
                // æ£€æŸ¥å­˜å‚¨å¯ç”¨æ€§
                if (!isStorageAvailable()) {
                    showNotification('âš ï¸ æ‚¨çš„æµè§ˆå™¨å¯èƒ½ç¦ç”¨äº†æœ¬åœ°å­˜å‚¨ï¼Œæ•°æ®å°†æ— æ³•ä¿å­˜ï¼', 'error');
                }
                
                // åŠ è½½æ•°æ®
                friendsData = loadFriendsDataFromStorage();
                console.log("åˆå§‹åŒ–çš„friendsData:", friendsData);
                
                // æ›´æ–°æ—¶é—´çº¿
                updateAllFriendsTimeline();
                
                // åŠ è½½å¥½å‹åˆ—è¡¨
                loadFriendsList();
                
                // æ˜¾ç¤ºæ•°æ®çŠ¶æ€
                updateDataStatus(true);
                
                // æ·»åŠ ä¸€äº›äº¤äº’æ•ˆæœ
                document.querySelectorAll('.btn').forEach(btn => {
                    btn.addEventListener('mousedown', () => {
                        btn.style.transform = 'translateY(0)';
                    });
                    
                    btn.addEventListener('mouseup', () => {
                        btn.style.transform = 'translateY(-3px)';
                    });
                    
                    btn.addEventListener('mouseleave', () => {
                        btn.style.transform = 'translateY(0)';
                    });
                });
                
                // é¡µé¢å¸è½½å‰ä¿å­˜æ•°æ®
                window.addEventListener('beforeunload', () => {
                    console.log("é¡µé¢å…³é—­å‰ä¿å­˜æ•°æ®...");
                    saveFriendsDataToStorage(friendsData);
                });
                
                // å®šæœŸè‡ªåŠ¨ä¿å­˜ï¼ˆæ¯30ç§’ï¼‰
                setInterval(() => {
                    if (friendsData.length > 0) {
                        console.log("è‡ªåŠ¨ä¿å­˜æ•°æ®...");
                        saveFriendsDataToStorage(friendsData);
                    }
                }, 30000);
                
                console.log("é¡µé¢åˆå§‹åŒ–å®Œæˆï¼");
            }
            
            // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
            init();
            
        }); // DOMContentLoaded ç»“æŸ
    </script>
</body>
</html>
