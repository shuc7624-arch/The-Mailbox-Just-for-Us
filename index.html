<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¥¬çš„æ¸©é¦¨æ—¶å…‰ç•™è¨€ç°¿ - å¥½å‹æ¡£æ¡ˆç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=ZCOOL+XiaoWei&display=swap" rel="stylesheet">
    <!-- å¼•å…¥ LeanCloud SDK -->
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.13.2/dist/av-min.js"></script>
    <style>
        /* ä¿æŒåŸæœ‰æ ·å¼ï¼Œåªæ·»åŠ å¿…è¦çš„ */
        
        /* åŠ è½½åŠ¨ç”» */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }
        
        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        .loading-text {
            color: white;
            font-size: 1.2rem;
            font-family: 'Ma Shan Zheng', cursive;
            text-align: center;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* è¿æ¥çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .status-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 0.9rem;
            z-index: 1000;
            font-family: 'Ma Shan Zheng', cursive;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }
        
        .status-indicator.hidden {
            transform: translateY(100%);
            opacity: 0;
        }
        
        .status-indicator.online {
            background: linear-gradient(90deg, var(--primary-color) 0%, #7C9EB2 100%);
            color: white;
            border: 2px solid var(--primary-color);
        }
        
        .status-indicator.offline {
            background: linear-gradient(90deg, #FFAAA5 0%, #FF7A7A 100%);
            color: white;
            border: 2px solid #FF7A7A;
        }
        
        .status-indicator.connecting {
            background: linear-gradient(90deg, #FFD3B6 0%, #FFAAA5 100%);
            color: var(--text-color);
            border: 2px solid #FFD3B6;
        }
        
        /* å¿«é€Ÿæ“ä½œæŒ‰é’® */
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .action-btn {
            padding: 10px 20px;
            background: linear-gradient(90deg, var(--primary-color) 0%, var(--accent-color) 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 0.9rem;
            transition: all 0.3s;
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 170, 165, 0.3);
        }
        
        .action-btn.secondary {
            background: linear-gradient(90deg, #7C9EB2 0%, #A8E6CF 100%);
        }
        
        .action-btn.warning {
            background: linear-gradient(90deg, #FFD3B6 0%, #FFAAA5 100%);
        }
        
        /* æ•°æ®ç»Ÿè®¡ */
        .data-stats {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .stat-badge {
            background: rgba(168, 230, 207, 0.2);
            border: 2px solid var(--primary-color);
            border-radius: 12px;
            padding: 8px 12px;
            text-align: center;
            min-width: 100px;
        }
        
        .stat-number {
            font-size: 1.4rem;
            font-weight: bold;
            color: var(--accent-color);
            font-family: 'Ma Shan Zheng', cursive;
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: var(--dark-color);
            margin-top: 3px;
        }
        
        /* æ¬¢è¿ä¿¡æ¯ */
        .welcome-message {
            font-size: 1.1rem;
            text-align: center;
            margin: 15px 0;
            color: var(--accent-color);
            font-family: 'Ma Shan Zheng', cursive;
            padding: 10px;
            background: rgba(168, 230, 207, 0.1);
            border-radius: 10px;
            border: 2px dashed var(--primary-color);
        }
    </style>
</head>
<body>
    <!-- åŠ è½½é®ç½© -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">ğŸ¥¬ æ­£åœ¨åŠ è½½æ—¶å…‰ç•™è¨€ç°¿...</div>
        <div class="loading-text" id="loading-detail" style="font-size: 1rem; margin-top: 10px;"></div>
    </div>
    
    <!-- èƒŒæ™¯è£…é¥°å…ƒç´  -->
    <div class="decoration dec-1">ğŸ¥¬</div>
    <div class="decoration dec-2">ğŸ¥¬</div>
    <div class="decoration dec-3">ğŸ¥¬</div>
    <div class="decoration dec-4">ğŸ¥¬</div>
    <div class="decoration dec-5">ğŸ¥¬</div>
    
    <!-- çŠ¶æ€æŒ‡ç¤ºå™¨ -->
    <div class="status-indicator hidden" id="status-indicator">
        <i class="fas fa-wifi" id="status-icon"></i>
        <span id="status-text">æ­£åœ¨è¿æ¥...</span>
    </div>
    
    <div class="container">
        <header>
            <div class="title-container">
                <h1><span>ğŸ¥¬</span> çš„æ¸©é¦¨æ—¶å…‰ç•™è¨€ç°¿ <span>ğŸ¥¬</span></h1>
                <p>è®°å½•ğŸ¥¬å’Œæœ‹å‹ä»¬çš„ç¾å¥½æ—¶å…‰ï¼Œç•™è¨€äº’åŠ¨ï¼Œå›½å†…æœåŠ¡å™¨æé€Ÿå“åº”ï¼</p>
                
                <!-- æ¬¢è¿ä¿¡æ¯ -->
                <div class="welcome-message" id="welcome-message">
                    ğŸ¥¬çš„æ¸©é¦¨æ—¶å…‰å°å±‹å·²å‡†å¤‡å°±ç»ª
                </div>
                
                <!-- æ•°æ®ç»Ÿè®¡ -->
                <div class="data-stats" id="data-stats">
                    <div class="stat-badge">
                        <div class="stat-number" id="friend-count">0</div>
                        <div class="stat-label">å¥½å‹æ¡£æ¡ˆ</div>
                    </div>
                    <div class="stat-badge">
                        <div class="stat-number" id="message-count">0</div>
                        <div class="stat-label">ç•™è¨€æ€»æ•°</div>
                    </div>
                    <div class="stat-badge">
                        <div class="stat-number" id="sync-status">åœ¨çº¿</div>
                        <div class="stat-label">åŒæ­¥çŠ¶æ€</div>
                    </div>
                </div>
            </div>
        </header>
        
        <div class="view-switcher">
            <button class="view-btn active" id="admin-btn">
                <i class="fas fa-heart"></i> ğŸ¥¬çš„ç®¡ç†ç©ºé—´
            </button>
            <button class="view-btn" id="user-btn">
                <i class="fas fa-user-friends"></i> æœ‹å‹æ¥è®¿å…¥å£
            </button>
        </div>
        
        <!-- ç®¡ç†å‘˜è§†è§’ -->
        <div class="view-container active" id="admin-view">
            <div class="password-section" id="password-section">
                <h3 class="section-title"><i class="fas fa-lock"></i> ğŸ¥¬çš„èº«ä»½éªŒè¯</h3>
                <div class="input-group">
                    <label for="admin-password">è¯·è¾“å…¥ğŸ¥¬çš„ä¸“å±å¯†ç </label>
                    <input type="password" id="admin-password" placeholder="åªæœ‰ğŸ¥¬çŸ¥é“çš„ç¥ç§˜å¯†ç ...">
                </div>
                <button class="btn" id="login-btn">
                    <i class="fas fa-door-open"></i> è¿›å…¥ğŸ¥¬çš„æ—¶å…‰å°å±‹
                </button>
                <div class="welcome-message" style="margin-top: 20px; font-size: 0.95rem;">
                    <i class="fas fa-bolt"></i> ä½¿ç”¨å›½å†…æœåŠ¡å™¨ï¼Œæé€Ÿå“åº”
                    <br>
                    <i class="fas fa-database"></i> æ•°æ®äº‘ç«¯å­˜å‚¨ï¼Œå¤šè®¾å¤‡åŒæ­¥
                </div>
            </div>
            
            <div class="admin-view hidden" id="admin-content">
                <div class="top-header">
                    <h2><i class="fas fa-heart"></i> ğŸ¥¬çš„ç®¡ç†ç©ºé—´</h2>
                    <button class="back-btn" id="admin-back-btn">
                        <i class="fas fa-arrow-left"></i> è¿”å›ç™»å½•
                    </button>
                </div>
                
                <div class="section">
                    <h2 class="section-title"><i class="fas fa-book-medical"></i> åˆ›å»ºå¥½å‹æ¡£æ¡ˆ</h2>
                    <form id="friend-form">
                        <div class="input-group">
                            <label for="friend-name">å¥½å‹å§“å</label>
                            <input type="text" id="friend-name" placeholder="è¯·è¾“å…¥å¥½å‹çš„å¯çˆ±åå­—" required>
                        </div>
                        
                        <div class="input-group">
                            <label for="admin-message">ğŸ¥¬æƒ³å¯¹ä½ è¯´</label>
                            <textarea id="admin-message" placeholder="è¾“å…¥ğŸ¥¬æƒ³å¯¹å¥½å‹è¯´çš„æ‚„æ‚„è¯..."></textarea>
                        </div>
                        
                        <div class="action-buttons">
                            <button type="submit" class="action-btn">
                                <i class="fas fa-heart"></i> ä¿å­˜å¥½å‹æ¡£æ¡ˆ
                            </button>
                            <button type="button" class="action-btn secondary" id="refresh-data-btn">
                                <i class="fas fa-sync-alt"></i> åˆ·æ–°æ•°æ®
                            </button>
                        </div>
                    </form>
                </div>
                
                <div class="section">
                    <h2 class="section-title"><i class="fas fa-book-open"></i> å·²åˆ›å»ºçš„å¥½å‹æ¡£æ¡ˆ</h2>
                    <div class="friend-list" id="friend-list">
                        <!-- å¥½å‹åˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                        <div class="no-data">
                            <i class="fas fa-users"></i>
                            <p>æ­£åœ¨ä»äº‘ç«¯åŠ è½½å¥½å‹æ¡£æ¡ˆ...</p>
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="action-btn" id="export-data-btn">
                            <i class="fas fa-download"></i> å¤‡ä»½æ•°æ®
                        </button>
                        <button class="action-btn secondary" id="clear-cache-btn">
                            <i class="fas fa-trash"></i> æ¸…ç†ç¼“å­˜
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ç”¨æˆ·è§†è§’ -->
        <div class="view-container" id="user-view">
            <!-- ç”¨æˆ·å†…å®¹ä¿æŒä¸å˜ -->
        </div>
        
        <footer>
            <p>Â© ğŸ¥¬çš„æ¸©é¦¨æ—¶å…‰ç•™è¨€ç°¿ | å›½å†…æœåŠ¡å™¨ï¼Œæé€Ÿå“åº”ï¼Œæ•°æ®å®‰å…¨</p>
            <p style="margin-top: 10px;">ğŸ¥¬ ä¼šä¸€ç›´è®°å½•ä¸æ¯ä½æœ‹å‹çš„ç¾å¥½æ—¶å…‰ ğŸ¥¬</p>
            <p style="font-size: 0.9rem; margin-top: 5px; color: var(--dark-color);">
                <i class="fas fa-bolt"></i> å›½å†…æœåŠ¡å™¨æé€Ÿå“åº” | 
                <i class="fas fa-shield-alt"></i> æ•°æ®åŠ å¯†å­˜å‚¨
            </p>
        </footer>
    </div>
    
    <!-- æ¨¡æ€æ¡†å’Œé€šçŸ¥ç»„ä»¶ä¿æŒä¸å˜ -->
    
    <script>
        // ========== LeanCloud é…ç½® ==========
        // è¯·å…ˆæ³¨å†Œ LeanCloud è´¦å·å¹¶åˆ›å»ºåº”ç”¨ï¼Œç„¶åå¡«å†™ä»¥ä¸‹ä¿¡æ¯
        const LEANCLOUD_CONFIG = {
            leancloudAppId: 'RUl0Sk2GPlzudKJhMstx5YHL-gzGzoHsz',           // æ›¿æ¢ä¸ºä½ çš„ LeanCloud App ID
            leancloudAppKey: 'aEqcQrG4RBoU83VSrnDVtoJk',         // æ›¿æ¢ä¸ºä½ çš„ LeanCloud App Key
            leancloudServerUrl: 'https://ru18sk2g.lc-cn-n1-shared.com',  // æ›¿æ¢ä¸ºä½ çš„ LeanCloud åŸŸåï¼ˆå¯é€‰ï¼Œä½†å»ºè®®å¡«å†™ï¼‰
        
            // æœ¬åœ°å­˜å‚¨ç›¸å…³
            localStorageKey: 'friends_album_data_v3',
            backupLocalStorageKey: 'friends_album_backup',
            
            // åŒæ­¥è®¾ç½®
            enableCloudSync: true,
            syncInterval: 30000,
            maxSyncRetries: 2,
        };
        
        // ç®¡ç†å‘˜å¯†ç 
        const ADMIN_PASSWORD = "v05708";
        
        // æ•°æ®è¡¨åç§°
        const TABLE_NAME = "Friends";
        
        // ========== åˆå§‹åŒ–å˜é‡ ==========
        let friendsData = [];
        let currentFriend = null;
        let currentFilter = "all";
        let managingFriend = null;
        let isConnected = false;
        let isLoading = false;
        
        // çº¯è‰²å¤´åƒé¢œè‰²æ•°ç»„
        const avatarColors = ['avatar-color-1', 'avatar-color-2', 'avatar-color-3', 'avatar-color-4', 'avatar-color-5', 'avatar-color-6'];
        
        // ========== DOM å…ƒç´  ==========
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingDetail = document.getElementById('loading-detail');
        const statusIndicator = document.getElementById('status-indicator');
        const statusIcon = document.getElementById('status-icon');
        const statusText = document.getElementById('status-text');
        const welcomeMessage = document.getElementById('welcome-message');
        const friendCount = document.getElementById('friend-count');
        const messageCount = document.getElementById('message-count');
        const syncStatus = document.getElementById('sync-status');
        const dataStats = document.getElementById('data-stats');
        
        // åŸæœ‰DOMå…ƒç´ 
        const adminBtn = document.getElementById('admin-btn');
        const userBtn = document.getElementById('user-btn');
        const adminView = document.getElementById('admin-view');
        const userView = document.getElementById('user-view');
        const passwordSection = document.getElementById('password-section');
        const adminContent = document.getElementById('admin-content');
        const loginBtn = document.getElementById('login-btn');
        const adminPasswordInput = document.getElementById('admin-password');
        const friendForm = document.getElementById('friend-form');
        const friendNameInput = document.getElementById('friend-name');
        const adminMessageInput = document.getElementById('admin-message');
        const refreshDataBtn = document.getElementById('refresh-data-btn');
        const friendList = document.getElementById('friend-list');
        const exportDataBtn = document.getElementById('export-data-btn');
        const clearCacheBtn = document.getElementById('clear-cache-btn');
        const userNameInput = document.getElementById('user-name');
        const searchBtn = document.getElementById('search-btn');
        const userResult = document.getElementById('user-result');
        const timelineSection = document.getElementById('timeline-section');
        const newMessageSection = document.getElementById('new-message-section');
        const userMessageInput = document.getElementById('user-message');
        const sendMessageBtn = document.getElementById('send-message-btn');
        const notificationContainer = document.getElementById('notification-container');
        const timelineFilter = document.getElementById('timeline-filter');
        const adminBackBtn = document.getElementById('admin-back-btn');
        const userBackBtn = document.getElementById('user-back-btn');
        
        // ç®¡ç†æ¨¡æ€æ¡†å…ƒç´ 
        const manageFriendModal = document.getElementById('manage-friend-modal');
        const closeManageModalBtn = document.getElementById('close-manage-modal');
        const manageFriendNameInput = document.getElementById('manage-friend-name');
        const manageAdminMessageInput = document.getElementById('manage-admin-message');
        const manageNewMessageInput = document.getElementById('manage-new-message');
        const saveManageBtn = document.getElementById('save-manage-btn');
        const addMessageBtn = document.getElementById('add-message-btn');
        
        // ========== è¾…åŠ©å‡½æ•° ==========
        
        // æ›´æ–°åŠ è½½çŠ¶æ€
        function updateLoading(message, show = true) {
            if (loadingDetail) {
                loadingDetail.textContent = message || '';
            }
            
            if (loadingOverlay) {
                if (show) {
                    loadingOverlay.classList.remove('hidden');
                    isLoading = true;
                } else {
                    setTimeout(() => {
                        loadingOverlay.classList.add('hidden');
                        isLoading = false;
                    }, 500);
                }
            }
        }
        
        // æ›´æ–°è¿æ¥çŠ¶æ€
        function updateStatus(message, type = 'connecting') {
            if (!statusIndicator || !statusText || !statusIcon) return;
            
            statusIndicator.className = `status-indicator ${type}`;
            statusText.textContent = message;
            
            // æ›´æ–°å›¾æ ‡
            switch(type) {
                case 'online':
                    statusIcon.className = 'fas fa-wifi';
                    break;
                case 'offline':
                    statusIcon.className = 'fas fa-exclamation-triangle';
                    break;
                case 'connecting':
                    statusIcon.className = 'fas fa-sync fa-spin';
                    break;
            }
            
            // æ˜¾ç¤ºçŠ¶æ€æŒ‡ç¤ºå™¨
            statusIndicator.classList.remove('hidden');
            
            // å¦‚æœæ˜¯æˆåŠŸçŠ¶æ€ï¼Œ3ç§’åéšè—
            if (type === 'online') {
                setTimeout(() => {
                    statusIndicator.classList.add('hidden');
                }, 3000);
            }
            
            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            if (syncStatus) {
                syncStatus.textContent = type === 'online' ? 'åœ¨çº¿' : 'ç¦»çº¿';
            }
        }
        
        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `<span>${message}</span>`;
            
            notificationContainer.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideIn 0.5s ease reverse';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 500);
            }, 3000);
        }
        
        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        function updateStats() {
            const totalFriends = friendsData.length;
            const totalMessages = friendsData.reduce((sum, friend) => {
                return sum + (friend.messages ? friend.messages.length : 0);
            }, 0);
            
            friendCount.textContent = totalFriends;
            messageCount.textContent = totalMessages;
            
            // æ›´æ–°æ¬¢è¿ä¿¡æ¯
            if (welcomeMessage) {
                if (totalFriends > 0) {
                    welcomeMessage.innerHTML = `<i class="fas fa-heart"></i> ğŸ¥¬å·²è®°å½•${totalFriends}ä½å¥½å‹ï¼Œ${totalMessages}æ¡ç•™è¨€`;
                } else {
                    welcomeMessage.textContent = 'ğŸ¥¬çš„æ¸©é¦¨æ—¶å…‰å°å±‹å·²å‡†å¤‡å°±ç»ª';
                }
            }
        }
        
        // å¤´åƒç›¸å…³å‡½æ•°
        function getAvatarColor(name) {
            if (!name) return 'avatar-color-1';
            let sum = 0;
            for (let i = 0; i < name.length; i++) {
                sum += name.charCodeAt(i);
            }
            return avatarColors[sum % avatarColors.length];
        }
        
        function getInitials(name) {
            if (!name) return '?';
            if (/[\u4e00-\u9fa5]/.test(name)) {
                return name.charAt(0);
            }
            return name.charAt(0).toUpperCase();
        }
        
        function generateSolidAvatar(name, size = 'small') {
            const colorClass = getAvatarColor(name);
            const initials = getInitials(name);
            
            if (size === 'large') {
                return `<div class="friend-profile-img ${colorClass}">${initials}</div>`;
            } else {
                return `<div class="friend-avatar ${colorClass}">${initials}</div>`;
            }
        }
        
        function updateFriendTimeline(friend) {
            if (!friend || !friend.messages) return;
            
            friend.timeline = [];
            
            if (friend.messages && friend.messages.length > 0) {
                friend.messages.forEach(message => {
                    friend.timeline.push({
                        ...message,
                        type: "message"
                    });
                });
            }
            
            friend.timeline.sort((a, b) => new Date(b.time) - new Date(a.time));
        }
        
        // ========== LeanCloud æ•°æ®æ“ä½œå‡½æ•° ==========
        
        // åˆå§‹åŒ– LeanCloud
        async function initCloudConnection() {
            // å¦‚æœæ²¡æœ‰é…ç½® LeanCloudï¼Œç›´æ¥è¿”å›
            if (!CONFIG.leancloudAppId || !CONFIG.leancloudAppKey || 
                !CONFIG.leancloudServerUrl || !CONFIG.enableCloudSync) {
                console.log('LeanCloud é…ç½®ä¸å®Œæ•´æˆ–å·²ç¦ç”¨');
                isCloudAvailable = false;
                return false;
            }
            
            try {
                console.log('æ­£åœ¨è¿æ¥ LeanCloud...');
                updateConnectionStatus('æ­£åœ¨è¿æ¥äº‘ç«¯...', 'connecting');
                
                // æµ‹è¯• LeanCloud è¿æ¥
                const testResponse = await fetch(`${CONFIG.leancloudServerUrl}/1.1/classes/Friends`, {
                    method: 'GET',
                    headers: {
                        'X-LC-Id': CONFIG.leancloudAppId,
                        'X-LC-Key': CONFIG.leancloudAppKey,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!testResponse.ok) {
                    console.warn('LeanCloud è¿æ¥æµ‹è¯•å¤±è´¥ï¼ˆä¸å½±å“ä½¿ç”¨ï¼‰:', testResponse.status);
                    isCloudAvailable = false;
                    updateConnectionStatus('äº‘ç«¯è¿æ¥å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°å­˜å‚¨', 'offline');
                    return false;
                }
                
                isCloudAvailable = true;
                updateConnectionStatus('äº‘ç«¯è¿æ¥æˆåŠŸ', 'online');
                console.log('LeanCloud è¿æ¥æˆåŠŸ');
                
                // å¯åŠ¨å®šæœŸåŒæ­¥
                startAutoSync();
                
                return true;
            } catch (error) {
                console.warn('LeanCloud åˆå§‹åŒ–å¤±è´¥ï¼ˆä¸å½±å“ä½¿ç”¨ï¼‰:', error.message);
                isCloudAvailable = false;
                updateConnectionStatus('äº‘ç«¯è¿æ¥å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°å­˜å‚¨', 'offline');
                return false;
            }
        }
        
        // ä» LeanCloud åŠ è½½å¥½å‹æ•°æ®
        async function loadFromCloud() {
            if (!isCloudAvailable) {
                console.log('äº‘ç«¯ä¸å¯ç”¨ï¼Œè·³è¿‡äº‘ç«¯åŠ è½½');
                return null;
            }
            
            try {
                console.log('æ­£åœ¨ä» LeanCloud åŠ è½½æ•°æ®...');
                updateConnectionStatus('æ­£åœ¨ä»äº‘ç«¯åŠ è½½...', 'connecting');
                
                const { data, error } = await fetchFromLeanCloud();
                
                if (error) {
                    throw new Error(`äº‘ç«¯åŠ è½½å¤±è´¥: ${error}`);
                }
                
                // è½¬æ¢æ•°æ®æ ¼å¼
                const formattedData = data.map(item => {
                    // è§£æå­˜å‚¨ä¸ºå­—ç¬¦ä¸²çš„æ•°ç»„
                    let messages = [];
                    let timeline = [];
                    
                    try {
                        messages = item.messages ? JSON.parse(item.messages) : [];
                    } catch (e) {
                        console.warn(`è§£æ messages å¤±è´¥:`, e);
                    }
                    
                    try {
                        timeline = item.timeline ? JSON.parse(item.timeline) : [];
                    } catch (e) {
                        console.warn(`è§£æ timeline å¤±è´¥:`, e);
                    }
                    
                    return {
                        id: item.objectId,
                        name: item.name,
                        adminMessage: item.adminMessage || '',
                        avatarColor: item.avatarColor || getAvatarColor(item.name),
                        messages: messages,
                        timeline: timeline,
                        created_at: item.createdAt || new Date().toISOString(),
                        updated_at: item.updatedAt || new Date().toISOString()
                    };
                });
                
                console.log('ä» LeanCloud åŠ è½½äº†', formattedData.length, 'æ¡è®°å½•');
                updateConnectionStatus('äº‘ç«¯æ•°æ®åŠ è½½å®Œæˆ', 'online');
                
                return formattedData;
            } catch (error) {
                console.error('ä» LeanCloud åŠ è½½å¤±è´¥:', error);
                updateConnectionStatus('äº‘ç«¯åŠ è½½å¤±è´¥', 'offline');
                return null;
            }
        }
        
        // ä¿å­˜å¥½å‹åˆ° LeanCloud
        async function saveToCloud(data) {
            if (!isCloudAvailable) {
                console.log('äº‘ç«¯ä¸å¯ç”¨ï¼Œè·³è¿‡äº‘ç«¯ä¿å­˜');
                return false;
            }
            
            try {
                console.log('æ­£åœ¨åŒæ­¥åˆ° LeanCloud...');
                updateConnectionStatus('æ­£åœ¨åŒæ­¥åˆ°äº‘ç«¯...', 'connecting');
                
                // é¦–å…ˆè·å–äº‘ç«¯å·²æœ‰çš„æ•°æ®ï¼Œç”¨äºåç»­çš„æ›´æ–°/åˆ é™¤
                const { data: existingData, error: fetchError } = await fetchFromLeanCloud();
                
                if (fetchError) {
                    console.warn('è·å–äº‘ç«¯æ•°æ®å¤±è´¥:', fetchError);
                }
                
                // è½¬æ¢æ•°æ®æ ¼å¼ä¸º LeanCloud éœ€è¦çš„æ ¼å¼
                const leancloudData = data.map(friend => {
                    // å¦‚æœäº‘ç«¯å·²ç»æœ‰è¿™ä¸ªæœ‹å‹çš„æ•°æ®ï¼Œä½¿ç”¨äº‘ç«¯çš„ objectId
                    let objectId = null;
                    if (existingData && existingData.length > 0) {
                        const existingFriend = existingData.find(item => item.name === friend.name);
                        if (existingFriend && existingFriend.objectId) {
                            objectId = existingFriend.objectId;
                        }
                    }
                    
                    return {
                        objectId: objectId,
                        name: friend.name,
                        adminMessage: friend.adminMessage || '',
                        avatarColor: friend.avatarColor || getAvatarColor(friend.name),
                        messages: JSON.stringify(friend.messages || []), // LeanCloud éœ€è¦å­—ç¬¦ä¸²
                        timeline: JSON.stringify(friend.timeline || []), // LeanCloud éœ€è¦å­—ç¬¦ä¸²
                        createdAt: friend.created_at || new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                });
                
                // æ‰¹é‡ä¿å­˜åˆ° LeanCloud
                const savePromises = leancloudData.map(async (friendData) => {
                    const method = friendData.objectId ? 'PUT' : 'POST';
                    const url = friendData.objectId 
                        ? `${CONFIG.leancloudServerUrl}/1.1/classes/Friends/${friendData.objectId}`
                        : `${CONFIG.leancloudServerUrl}/1.1/classes/Friends`;
                    
                    // ç§»é™¤ objectIdï¼Œå› ä¸º POST ä¸éœ€è¦ï¼ŒPUT åœ¨ URL ä¸­å·²åŒ…å«
                    const dataToSend = { ...friendData };
                    delete dataToSend.objectId;
                    
                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'X-LC-Id': CONFIG.leancloudAppId,
                            'X-LC-Key': CONFIG.leancloudAppKey,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(dataToSend)
                    });
                    
                    if (!response.ok) {
                        throw new Error(`ä¿å­˜ ${friendData.name} å¤±è´¥: ${response.status}`);
                    }
                    
                    return response.json();
                });
                
                // ç­‰å¾…æ‰€æœ‰ä¿å­˜æ“ä½œå®Œæˆ
                await Promise.all(savePromises);
                
                // æ¸…ç†äº‘ç«¯ä¸­æœ¬åœ°å·²åˆ é™¤çš„æ•°æ®
                if (existingData && existingData.length > 0) {
                    const localNames = new Set(data.map(f => f.name));
                    const friendsToDelete = existingData.filter(f => !localNames.has(f.name));
                    
                    const deletePromises = friendsToDelete.map(async (friend) => {
                        if (friend.objectId) {
                            const response = await fetch(`${CONFIG.leancloudServerUrl}/1.1/classes/Friends/${friend.objectId}`, {
                                method: 'DELETE',
                                headers: {
                                    'X-LC-Id': CONFIG.leancloudAppId,
                                    'X-LC-Key': CONFIG.leancloudAppKey
                                }
                            });
                            
                            if (!response.ok) {
                                console.warn(`åˆ é™¤äº‘ç«¯æ•°æ® ${friend.name} å¤±è´¥`);
                            }
                        }
                    });
                    
                    await Promise.all(deletePromises);
                }
                
                updateConnectionStatus('äº‘ç«¯åŒæ­¥å®Œæˆ', 'online');
                console.log('LeanCloud åŒæ­¥å®Œæˆï¼Œä¸Šä¼ äº†', data.length, 'æ¡è®°å½•');
                return true;
                
            } catch (error) {
                console.error('LeanCloud åŒæ­¥å¤±è´¥:', error);
                updateConnectionStatus('äº‘ç«¯åŒæ­¥å¤±è´¥', 'offline');
                return false;
            }
        }

        // ä» LeanCloud è·å–æ•°æ®çš„è¾…åŠ©å‡½æ•°
        async function fetchFromLeanCloud() {
            try {
                const response = await fetch(`${CONFIG.leancloudServerUrl}/1.1/classes/Friends`, {
                    method: 'GET',
                    headers: {
                        'X-LC-Id': CONFIG.leancloudAppId,
                        'X-LC-Key': CONFIG.leancloudAppKey,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const result = await response.json();
                return { data: result.results || [], error: null };
            } catch (error) {
                return { data: [], error: error.message };
            }
        }
        
        // ä» LeanCloud åˆ é™¤å¥½å‹
        async function deleteFriendFromCloud(friendId) {
            if (!isConnected) {
                console.log('æœªè¿æ¥åˆ°äº‘ç«¯ï¼Œè·³è¿‡åˆ é™¤');
                return false;
            }
            
            try {
                const friendObject = AV.Object.createWithoutData(TABLE_NAME, friendId);
                await friendObject.destroy();
                
                console.log('ä»äº‘ç«¯åˆ é™¤å¥½å‹æˆåŠŸ:', friendId);
                return true;
                
            } catch (error) {
                console.error('ä»äº‘ç«¯åˆ é™¤å¥½å‹å¤±è´¥:', error);
                showNotification('åˆ é™¤å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                return false;
            }
        }
        
        // ========== æœ¬åœ°ç¼“å­˜å‡½æ•° ==========
        
        // ä¿å­˜åˆ°æœ¬åœ°ç¼“å­˜
        function saveToLocalCache(data) {
            try {
                const cacheData = {
                    data: data,
                    timestamp: Date.now(),
                    version: 'v2'
                };
                
                localStorage.setItem('friends_cache', JSON.stringify(cacheData));
                console.log('æ•°æ®å·²ä¿å­˜åˆ°æœ¬åœ°ç¼“å­˜:', data.length, 'æ¡è®°å½•');
                return true;
                
            } catch (error) {
                console.error('ä¿å­˜åˆ°æœ¬åœ°ç¼“å­˜å¤±è´¥:', error);
                return false;
            }
        }
        
        // ä»æœ¬åœ°ç¼“å­˜åŠ è½½
        function loadFromLocalCache() {
            try {
                const cached = localStorage.getItem('friends_cache');
                if (!cached) return [];
                
                const parsed = JSON.parse(cached);
                
                // æ£€æŸ¥ç¼“å­˜æ˜¯å¦è¿‡æœŸï¼ˆ24å°æ—¶ï¼‰
                if (Date.now() - parsed.timestamp > 24 * 60 * 60 * 1000) {
                    console.log('æœ¬åœ°ç¼“å­˜å·²è¿‡æœŸ');
                    return [];
                }
                
                if (parsed.version === 'v2' && parsed.data) {
                    console.log('ä»æœ¬åœ°ç¼“å­˜åŠ è½½æ•°æ®:', parsed.data.length, 'æ¡è®°å½•');
                    return parsed.data;
                }
                
                return [];
                
            } catch (error) {
                console.error('ä»æœ¬åœ°ç¼“å­˜åŠ è½½å¤±è´¥:', error);
                return [];
            }
        }
        
        // ========== æ™ºèƒ½æ•°æ®ç®¡ç†å‡½æ•° ==========
        
        // åŠ è½½å¥½å‹æ•°æ®ï¼ˆå…ˆå°è¯•ç¼“å­˜ï¼Œå†å°è¯•äº‘ç«¯ï¼‰
        async function loadFriendsData() {
            updateLoading('æ­£åœ¨åŠ è½½å¥½å‹æ•°æ®...');
            
            let data = [];
            
            // 1. å…ˆå°è¯•ä»æœ¬åœ°ç¼“å­˜åŠ è½½
            const cachedData = loadFromLocalCache();
            if (cachedData.length > 0) {
                data = cachedData;
                updateStats();
                console.log('ä½¿ç”¨æœ¬åœ°ç¼“å­˜æ•°æ®');
            }
            
            // 2. å°è¯•ä»äº‘ç«¯åŠ è½½ï¼ˆå¦‚æœå·²è¿æ¥ï¼‰
            if (isConnected) {
                try {
                    const cloudData = await loadFriendsFromCloud();
                    
                    if (cloudData.length > 0) {
                        // äº‘ç«¯æœ‰æ•°æ®ï¼Œåˆå¹¶å¹¶æ›´æ–°ç¼“å­˜
                        data = mergeFriendsData(data, cloudData);
                        saveToLocalCache(data);
                        
                        if (cloudData.length > cachedData.length) {
                            console.log('ä»äº‘ç«¯æ›´æ–°äº†æ•°æ®');
                        }
                    }
                    
                } catch (error) {
                    console.warn('äº‘ç«¯æ•°æ®åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®:', error.message);
                }
            }
            
            friendsData = data;
            updateStats();
            updateLoading('');
            
            return data;
        }
        
        // åˆå¹¶æ•°æ®ï¼ˆç®€å•çš„åŸºäºåç§°çš„åˆå¹¶ï¼‰
        function mergeFriendsData(localData, cloudData) {
            const merged = [...localData];
            const existingNames = new Set(localData.map(f => f.name.toLowerCase()));
            
            // æ·»åŠ äº‘ç«¯ä¸­æœ¬åœ°æ²¡æœ‰çš„æ•°æ®
            cloudData.forEach(cloudFriend => {
                if (!existingNames.has(cloudFriend.name.toLowerCase())) {
                    merged.push(cloudFriend);
                } else {
                    // åŒåæ•°æ®ï¼Œä¿ç•™æ›´æ–°æ—¶é—´è¾ƒæ–°çš„
                    const localFriend = localData.find(f => f.name.toLowerCase() === cloudFriend.name.toLowerCase());
                    const localTime = new Date(localFriend.updatedAt || localFriend.createdAt || 0);
                    const cloudTime = new Date(cloudFriend.updatedAt || cloudFriend.createdAt || 0);
                    
                    if (cloudTime > localTime) {
                        // ç”¨äº‘ç«¯æ•°æ®æ›¿æ¢æœ¬åœ°æ•°æ®
                        const index = merged.findIndex(f => f.name.toLowerCase() === cloudFriend.name.toLowerCase());
                        if (index !== -1) {
                            merged[index] = cloudFriend;
                        }
                    }
                }
            });
            
            return merged;
        }
        
        // ä¿å­˜å¥½å‹æ•°æ®
        async function saveFriendsData(friend, isNew = true) {
            // å¦‚æœæ˜¯æ–°å¥½å‹ï¼Œæ·»åŠ åˆ°æ•°ç»„
            if (isNew) {
                friendsData.push(friend);
            } else {
                // æ›´æ–°ç°æœ‰å¥½å‹
                const index = friendsData.findIndex(f => f.id === friend.id);
                if (index !== -1) {
                    friendsData[index] = friend;
                }
            }
            
            // æ›´æ–°ç»Ÿè®¡æ•°æ®
            updateStats();
            
            // ä¿å­˜åˆ°æœ¬åœ°ç¼“å­˜
            saveToLocalCache(friendsData);
            
            // ä¿å­˜åˆ°äº‘ç«¯ï¼ˆå¼‚æ­¥ï¼‰
            if (isConnected) {
                try {
                    const savedFriend = await saveFriendToCloud(friend);
                    if (savedFriend && isNew) {
                        // æ›´æ–°ID
                        const index = friendsData.findIndex(f => f.name === friend.name);
                        if (index !== -1) {
                            friendsData[index].id = savedFriend.id;
                        }
                    }
                } catch (error) {
                    console.warn('äº‘ç«¯ä¿å­˜å¤±è´¥ï¼Œæ•°æ®å·²ä¿å­˜åˆ°æœ¬åœ°:', error.message);
                }
            }
            
            return friend;
        }
        
        // åˆ é™¤å¥½å‹æ•°æ®
        async function deleteFriendsData(friendId) {
            // ä»æœ¬åœ°æ•°ç»„ä¸­åˆ é™¤
            friendsData = friendsData.filter(f => f.id !== friendId);
            
            // æ›´æ–°æœ¬åœ°ç¼“å­˜
            saveToLocalCache(friendsData);
            
            // ä»äº‘ç«¯åˆ é™¤ï¼ˆå¼‚æ­¥ï¼‰
            if (isConnected) {
                try {
                    await deleteFriendFromCloud(friendId);
                } catch (error) {
                    console.warn('äº‘ç«¯åˆ é™¤å¤±è´¥ï¼Œæ•°æ®å·²ä»æœ¬åœ°åˆ é™¤:', error.message);
                }
            }
            
            // æ›´æ–°ç»Ÿè®¡æ•°æ®
            updateStats();
            
            return true;
        }
        
        // ========== æ˜¾ç¤ºç›¸å…³å‡½æ•° ==========
        
        // åŠ è½½å¥½å‹åˆ—è¡¨
        async function loadFriendsList() {
            if (!friendList) return;
            
            if (friendsData.length === 0) {
                friendList.innerHTML = `
                    <div class="no-data">
                        <i class="fas fa-users"></i>
                        <p>è¿˜æ²¡æœ‰å¥½å‹æ¡£æ¡ˆï¼Œå¿«ä¸ºä½ çš„æœ‹å‹åˆ›å»ºä¸€ä¸ªå§ï¼</p>
                    </div>
                `;
                return;
            }
            
            friendList.innerHTML = '';
            
            friendsData.forEach(friend => {
                const avatarHtml = generateSolidAvatar(friend.name, 'small');
                
                const friendItem = document.createElement('div');
                friendItem.className = 'friend-item';
                friendItem.innerHTML = `
                    ${avatarHtml}
                    <div class="friend-info">
                        <h4>${friend.name}</h4>
                        <p>${friend.adminMessage.substring(0, 60)}${friend.adminMessage.length > 60 ? '...' : ''}</p>
                        <p style="font-size: 0.9rem; color: var(--accent-color); margin-top: 5px;">
                            <i class="fas fa-comments"></i> ${friend.messages ? friend.messages.length : 0} æ¡ç•™è¨€
                            ${friend.updatedAt ? `<br><small>æ›´æ–°äºï¼š${new Date(friend.updatedAt).toLocaleDateString()}</small>` : ''}
                        </p>
                    </div>
                    <div class="friend-actions">
                        <button class="action-btn view-friend-btn" data-id="${friend.id}">
                            <i class="fas fa-heart"></i>
                        </button>
                        <button class="action-btn manage-friend-btn" data-id="${friend.id}">
                            <i class="fas fa-cog"></i>
                        </button>
                        <button class="action-btn delete-friend-btn" data-id="${friend.id}">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                `;
                
                friendList.appendChild(friendItem);
            });
            
            // æ·»åŠ äº‹ä»¶ç›‘å¬
            addFriendListEventListeners();
        }
        
        function addFriendListEventListeners() {
            document.querySelectorAll('.view-friend-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const friendId = e.currentTarget.getAttribute('data-id');
                    viewFriend(friendId);
                });
            });
            
            document.querySelectorAll('.manage-friend-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const friendId = e.currentTarget.getAttribute('data-id');
                    openManageModal(friendId);
                });
            });
            
            document.querySelectorAll('.delete-friend-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const friendId = e.currentTarget.getAttribute('data-id');
                    deleteFriend(friendId);
                });
            });
        }
        
        function resetUserSearch() {
            userResult.innerHTML = `
                <div class="no-data">
                    <i class="fas fa-heart"></i>
                    <p>è¾“å…¥ä½ çš„åå­—ï¼Œçœ‹çœ‹ğŸ¥¬ç»™ä½ ç•™äº†ä»€ä¹ˆè¯</p>
                </div>
            `;
            timelineSection.innerHTML = `
                <div class="no-data">
                    <i class="fas fa-clock"></i>
                    <p>æ‰¾åˆ°ä½ çš„æ¡£æ¡ˆåï¼Œå¯ä»¥åœ¨è¿™é‡ŒæŸ¥çœ‹ğŸ¥¬ä¸ºä½ è®°å½•çš„æ—¶å…‰</p>
                </div>
            `;
            newMessageSection.classList.add('hidden');
            userNameInput.value = '';
            userBackBtn.classList.add('hidden');
        }
        
        function displayFriendProfile(friend) {
            if (!friend) return;
            
            currentFriend = friend;
            
            const avatarHtml = generateSolidAvatar(friend.name, 'large');
            
            userResult.innerHTML = `
                <div class="friend-profile">
                    <div class="friend-avatar-container">
                        ${avatarHtml}
                    </div>
                    <h3>${friend.name}</h3>
                    <p>æ¬¢è¿æ¥åˆ°ä½ çš„ä¸“å±æ¡£æ¡ˆï¼ğŸ¥¬ä¸ºä½ è®°å½•äº†ä¸€äº›ç¾å¥½æ—¶åˆ»ï½</p>
                </div>
            `;
            
            displayTimeline(friend);
            newMessageSection.classList.remove('hidden');
            userMessageInput.value = '';
            userBackBtn.classList.remove('hidden');
        }
        
        function displayTimeline(friend) {
            if (!friend || !friend.timeline || friend.timeline.length === 0) {
                timelineSection.innerHTML = `
                    <div class="no-data">
                        <i class="fas fa-clock"></i>
                        <p>è¿˜æ²¡æœ‰æ—¶é—´çº¿è®°å½•</p>
                    </div>
                `;
                return;
            }
            
            let filteredTimeline = friend.timeline;
            if (currentFilter === 'message') {
                filteredTimeline = friend.timeline.filter(item => item.type === 'message');
            }
            
            timelineSection.innerHTML = '<div class="timeline">';
            
            filteredTimeline.forEach(item => {
                const timelineItem = document.createElement('div');
                timelineItem.className = 'timeline-item';
                
                if (item.type === 'message') {
                    timelineItem.innerHTML = `
                        <div class="timeline-icon">
                            <i class="fas fa-comment"></i>
                        </div>
                        <div class="timeline-content">
                            <div class="timeline-header">
                                <span class="timeline-sender">${item.sender}</span>
                                <span class="timeline-time">${item.time}</span>
                            </div>
                            <div class="timeline-message">${item.content}</div>
                        </div>
                    `;
                }
                
                timelineSection.querySelector('.timeline').appendChild(timelineItem);
            });
            
            timelineSection.innerHTML += '</div>';
        }
        
        // ========== äº‹ä»¶ç›‘å¬å™¨ ==========
        
        // è§†è§’åˆ‡æ¢
        adminBtn.addEventListener('click', () => {
            adminBtn.classList.add('active');
            userBtn.classList.remove('active');
            adminView.classList.add('active');
            userView.classList.remove('active');
            
            adminContent.classList.add('hidden');
            passwordSection.classList.remove('hidden');
            adminPasswordInput.value = '';
        });
        
        userBtn.addEventListener('click', () => {
            userBtn.classList.add('active');
            adminBtn.classList.remove('active');
            userView.classList.add('active');
            adminView.classList.remove('active');
            
            resetUserSearch();
            currentFriend = null;
        });
        
        // ç®¡ç†å‘˜ç™»å½•
        loginBtn.addEventListener('click', () => {
            const password = adminPasswordInput.value;
            
            if (password === ADMIN_PASSWORD) {
                passwordSection.classList.add('hidden');
                adminContent.classList.remove('hidden');
                showNotification('æ¬¢è¿å›æ¥ï¼ŒğŸ¥¬ï¼', 'success');
                loadFriendsList();
            } else {
                showNotification('å¯†ç ä¸å¯¹å“¦ï¼Œå†è¯•è¯•çœ‹ï¼', 'error');
                adminPasswordInput.value = '';
                adminPasswordInput.focus();
            }
        });
        
        // ç®¡ç†å‘˜è¿”å›
        adminBackBtn.addEventListener('click', () => {
            adminContent.classList.add('hidden');
            passwordSection.classList.remove('hidden');
            adminPasswordInput.value = '';
        });
        
        // ç”¨æˆ·è¿”å›
        userBackBtn.addEventListener('click', () => {
            resetUserSearch();
            currentFriend = null;
        });
        
        // åˆ›å»ºå¥½å‹æ¡£æ¡ˆ
        friendForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = friendNameInput.value.trim();
            const adminMessage = adminMessageInput.value.trim();
            
            if (!name) {
                showNotification('è¯·è¾“å…¥å¥½å‹çš„åå­—å“¦ï¼', 'error');
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨åŒåå¥½å‹
            const existingFriend = friendsData.find(friend => friend.name.toLowerCase() === name.toLowerCase());
            if (existingFriend) {
                showNotification('å·²ç»æœ‰åŒåå¥½å‹çš„æ¡£æ¡ˆå•¦ï¼æ¢ä¸ªåå­—è¯•è¯•ï¼Ÿ', 'error');
                return;
            }
            
            const now = new Date();
            const timeString = now.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            }).replace(/\//g, '-');
            
            const avatarColor = getAvatarColor(name);
            
            const newFriend = {
                name: name,
                adminMessage: adminMessage || "ğŸ¥¬æƒ³å¯¹ä½ è¯´ï¼šå¾ˆé«˜å…´è®¤è¯†ä½ ï¼",
                avatarColor: avatarColor,
                messages: [],
                timeline: [],
                createdAt: now.toISOString()
            };
            
            const initialMessage = {
                sender: "ğŸ¥¬",
                content: adminMessage || "ğŸ¥¬æƒ³å¯¹ä½ è¯´ï¼šå¾ˆé«˜å…´è®¤è¯†ä½ ï¼",
                time: timeString,
                type: "message"
            };
            newFriend.messages.push(initialMessage);
            newFriend.timeline.push(initialMessage);
            
            updateFriendTimeline(newFriend);
            
            // ä¿å­˜æ•°æ®
            const savedFriend = await saveFriendsData(newFriend, true);
            
            if (savedFriend) {
                friendForm.reset();
                loadFriendsList();
                showNotification(`å¥½å‹ "${name}" çš„æ¡£æ¡ˆåˆ›å»ºæˆåŠŸï¼ğŸ¥¬`, 'success');
            }
        });
        
        // åˆ·æ–°æ•°æ®æŒ‰é’®
        if (refreshDataBtn) {
            refreshDataBtn.addEventListener('click', async () => {
                showNotification('æ­£åœ¨åˆ·æ–°æ•°æ®...', 'info');
                await loadFriendsData();
                loadFriendsList();
                showNotification('æ•°æ®åˆ·æ–°å®Œæˆ', 'success');
            });
        }
        
        // å¯¼å‡ºæ•°æ®æŒ‰é’®
        if (exportDataBtn) {
            exportDataBtn.addEventListener('click', () => {
                const dataToExport = {
                    version: 'v2',
                    timestamp: new Date().toISOString(),
                    count: friendsData.length,
                    data: friendsData
                };
                
                const dataStr = JSON.stringify(dataToExport, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
                
                const exportFileName = `ğŸ¥¬æ—¶å…‰ç•™è¨€ç°¿å¤‡ä»½_${new Date().toISOString().split('T')[0]}.json`;
                
                const link = document.createElement('a');
                link.setAttribute('href', dataUri);
                link.setAttribute('download', exportFileName);
                link.click();
                
                showNotification('æ•°æ®å¤‡ä»½æ–‡ä»¶å·²ç”Ÿæˆï¼Œè¯·ä¿å­˜åˆ°å®‰å…¨ä½ç½®', 'success');
            });
        }
        
        // æ¸…ç†ç¼“å­˜æŒ‰é’®
        if (clearCacheBtn) {
            clearCacheBtn.addEventListener('click', () => {
                if (confirm('ç¡®å®šè¦æ¸…ç†æœ¬åœ°ç¼“å­˜å—ï¼Ÿè¿™ä¼šåˆ é™¤æœ¬åœ°ä¿å­˜çš„æ•°æ®ï¼Œä½†ä¸ä¼šå½±å“äº‘ç«¯æ•°æ®ã€‚')) {
                    localStorage.removeItem('friends_cache');
                    showNotification('æœ¬åœ°ç¼“å­˜å·²æ¸…ç†', 'info');
                }
            });
        }
        
        // æŸ¥çœ‹å¥½å‹æ¡£æ¡ˆ
        function viewFriend(friendId) {
            const friend = friendsData.find(f => f.id === friendId);
            if (!friend) {
                showNotification('æ‰¾ä¸åˆ°å¥½å‹æ¡£æ¡ˆ', 'error');
                return;
            }
            
            userBtn.click();
            userNameInput.value = friend.name;
            displayFriendProfile(friend);
        }
        
        // åˆ é™¤å¥½å‹æ¡£æ¡ˆ
        async function deleteFriend(friendId) {
            const friend = friendsData.find(f => f.id === friendId);
            if (!friend) return;
            
            if (confirm(`ç¡®å®šè¦åˆ é™¤å¥½å‹ "${friend.name}" çš„æ¡£æ¡ˆå—ï¼Ÿè¿™å°†ä¼šåˆ é™¤æ‰€æœ‰ç•™è¨€è®°å½•ã€‚`)) {
                await deleteFriendsData(friendId);
                loadFriendsList();
                showNotification(`å¥½å‹ "${friend.name}" çš„æ¡£æ¡ˆå·²åˆ é™¤æˆåŠŸï¼`, 'info');
            }
        }
        
        // æ—¶é—´çº¿è¿‡æ»¤å™¨
        timelineFilter.addEventListener('click', (e) => {
            if (e.target.classList.contains('filter-btn')) {
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                e.target.classList.add('active');
                
                currentFilter = e.target.getAttribute('data-filter');
                
                if (currentFriend) {
                    displayTimeline(currentFriend);
                }
            }
        });
        
        // ç”¨æˆ·æœç´¢å¥½å‹æ¡£æ¡ˆ
        searchBtn.addEventListener('click', searchFriend);
        
        userNameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchFriend();
            }
        });
        
        function searchFriend() {
            const name = userNameInput.value.trim();
            
            if (!name) {
                showNotification('è¯·è¾“å…¥ä½ çš„åå­—å“¦ï¼', 'error');
                return;
            }
            
            const friend = friendsData.find(f => f.name.toLowerCase() === name.toLowerCase());
            
            if (friend) {
                displayFriendProfile(friend);
            } else {
                userResult.innerHTML = `
                    <div class="no-data">
                        <i class="fas fa-user-slash"></i>
                        <p style="color: #FF7A7A;">è¯·ç§èŠğŸ¥¬å¹¶è€å¿ƒç­‰å¾…ä¸€ä¼šå“¦~</p>
                        <p style="margin-top: 10px; font-size: 1rem;">ğŸ¥¬è¿˜æ²¡æœ‰åˆ›å»ºä½ çš„æ¡£æ¡ˆ</p>
                    </div>
                `;
                
                timelineSection.innerHTML = `
                    <div class="no-data">
                        <i class="fas fa-clock"></i>
                        <p>è¿˜æ²¡æœ‰æ—¶é—´çº¿è®°å½•</p>
                    </div>
                `;
                
                newMessageSection.classList.add('hidden');
                userBackBtn.classList.remove('hidden');
                currentFriend = null;
            }
        }
        
        // å‘é€ç•™è¨€
        sendMessageBtn.addEventListener('click', async () => {
            if (!currentFriend) {
                showNotification('è¯·å…ˆæŸ¥æ‰¾ä½ çš„æ¡£æ¡ˆï¼', 'error');
                return;
            }
            
            const message = userMessageInput.value.trim();
            
            if (!message) {
                showNotification('è¯·è¾“å…¥ç•™è¨€å†…å®¹å“¦ï¼', 'error');
                return;
            }
            
            const now = new Date();
            const timeString = now.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            }).replace(/\//g, '-');
            
            const newMessage = {
                sender: currentFriend.name,
                content: message,
                time: timeString,
                type: 'message'
            };
            
            // æ‰¾åˆ°å¥½å‹å¹¶æ·»åŠ ç•™è¨€
            const friend = friendsData.find(f => f.id === currentFriend.id);
            if (friend) {
                if (!friend.messages) friend.messages = [];
                friend.messages.push(newMessage);
                updateFriendTimeline(friend);
                
                // ä¿å­˜æ•°æ®
                await saveFriendsData(friend, false);
                
                // æ›´æ–°æ˜¾ç¤º
                currentFriend = friend;
                displayTimeline(friend);
                userMessageInput.value = '';
                
                showNotification('ç•™è¨€å‘é€æˆåŠŸï¼ğŸ¥¬ä¼šå¾ˆå¿«å›å¤ä½ çš„ï¼', 'success');
                
                // æ¨¡æ‹ŸğŸ¥¬å›å¤
                setTimeout(async () => {
                    const replies = [
                        "æ”¶åˆ°ä½ çš„ç•™è¨€å•¦ï¼Œå¥½å¼€å¿ƒï¼",
                        "è°¢è°¢ä½ çš„ç•™è¨€ï¼Œæˆ‘ä¼šä¸€ç›´çæƒœæˆ‘ä»¬çš„å‹è°Šï¼",
                        "çœ‹åˆ°ä½ çš„ç•™è¨€å¿ƒé‡Œæš–æš–çš„ï¼",
                        "è°¢è°¢å…³å¿ƒï¼Œä½ ä¹Ÿè¦ç…§é¡¾å¥½è‡ªå·±å“¦ï¼",
                        "å·²æ”¶åˆ°ï¼ŒæœŸå¾…ä¸‹æ¬¡è§é¢ï¼",
                        "ä½ çš„ç•™è¨€è®©æˆ‘ä»Šå¤©çš„å¿ƒæƒ…éƒ½å˜å¥½äº†ï¼",
                        "å‹è°Šä¸‡å²ï¼ğŸ¥¬æ°¸è¿œæ˜¯ä½ çš„æœ‹å‹ï¼"
                    ];
                    
                    const randomReply = replies[Math.floor(Math.random() * replies.length)];
                    
                    const replyMessage = {
                        sender: "ğŸ¥¬",
                        content: randomReply,
                        time: new Date(now.getTime() + 60000).toLocaleString('zh-CN', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                        }).replace(/\//g, '-'),
                        type: 'message'
                    };
                    
                    friend.messages.push(replyMessage);
                    updateFriendTimeline(friend);
                    
                    await saveFriendsData(friend, false);
                    
                    currentFriend = friend;
                    displayTimeline(friend);
                    
                    showNotification('ğŸ¥¬å›å¤äº†ä½ çš„ç•™è¨€ï¼', 'info');
                }, 2000);
            }
        });
        
        // æ‰“å¼€ç®¡ç†æ¨¡æ€æ¡†
        function openManageModal(friendId) {
            const friend = friendsData.find(f => f.id === friendId);
            if (!friend) {
                showNotification('åŠ è½½å¥½å‹æ¡£æ¡ˆå¤±è´¥', 'error');
                return;
            }
            
            managingFriend = friend;
            manageFriendNameInput.value = friend.name;
            manageAdminMessageInput.value = friend.adminMessage || '';
            manageNewMessageInput.value = '';
            manageFriendModal.classList.add('active');
        }
        
        // ä¿å­˜ç®¡ç†æ›´æ”¹
        saveManageBtn.addEventListener('click', async () => {
            if (!managingFriend) return;
            
            const friend = friendsData.find(f => f.id === managingFriend.id);
            if (!friend) return;
            
            // æ›´æ–°ç®¡ç†å‘˜ç•™è¨€
            friend.adminMessage = manageAdminMessageInput.value.trim() || friend.adminMessage;
            
            // æ·»åŠ æ–°ç•™è¨€ï¼ˆå¦‚æœæœ‰ï¼‰
            const newMessageContent = manageNewMessageInput.value.trim();
            if (newMessageContent) {
                const now = new Date();
                const timeString = now.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                }).replace(/\//g, '-');
                
                const newMessage = {
                    sender: "ğŸ¥¬",
                    content: newMessageContent,
                    time: timeString,
                    type: 'message'
                };
                
                if (!friend.messages) friend.messages = [];
                friend.messages.push(newMessage);
            }
            
            updateFriendTimeline(friend);
            
            await saveFriendsData(friend, false);
            
            manageNewMessageInput.value = '';
            manageFriendModal.classList.remove('active');
            
            loadFriendsList();
            showNotification(`å¥½å‹ "${friend.name}" çš„æ¡£æ¡ˆå·²æ›´æ–°æˆåŠŸï¼ğŸ¥¬`, 'success');
        });
        
        // ä»…æ·»åŠ ç•™è¨€æŒ‰é’®
        addMessageBtn.addEventListener('click', async () => {
            if (!managingFriend) return;
            
            const newMessageContent = manageNewMessageInput.value.trim();
            if (!newMessageContent) {
                showNotification('è¯·è¾“å…¥ç•™è¨€å†…å®¹ï¼', 'error');
                return;
            }
            
            const friend = friendsData.find(f => f.id === managingFriend.id);
            if (!friend) return;
            
            const now = new Date();
            const timeString = now.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            }).replace(/\//g, '-');
            
            const newMessage = {
                sender: "ğŸ¥¬",
                content: newMessageContent,
                time: timeString,
                type: 'message'
            };
            
            if (!friend.messages) friend.messages = [];
            friend.messages.push(newMessage);
            updateFriendTimeline(friend);
            
            await saveFriendsData(friend, false);
            
            manageNewMessageInput.value = '';
            loadFriendsList();
            showNotification(`å·²ä¸º "${friend.name}" æ·»åŠ æ–°ç•™è¨€æˆåŠŸï¼ğŸ¥¬`, 'success');
        });
        
        // å…³é—­ç®¡ç†æ¨¡æ€æ¡†
        closeManageModalBtn.addEventListener('click', () => {
            manageFriendModal.classList.remove('active');
        });
        
        manageFriendModal.addEventListener('click', (e) => {
            if (e.target === manageFriendModal) {
                manageFriendModal.classList.remove('active');
            }
        });
        
        // ========== åˆå§‹åŒ–é¡µé¢ ==========
        async function init() {
            console.log('ğŸ¥¬ åˆå§‹åŒ–é¡µé¢...');
            
            // 1. åˆå§‹åŒ– LeanCloud è¿æ¥
            const connected = await initLeanCloud();
            
            if (connected) {
                // 2. åŠ è½½å¥½å‹æ•°æ®
                await loadFriendsData();
                
                // 3. éšè—åŠ è½½ç•Œé¢
                updateLoading('', false);
                
                // 4. æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                showNotification('ğŸ¥¬çš„æ—¶å…‰ç•™è¨€ç°¿å·²å°±ç»ªï¼', 'success');
                
                console.log('ğŸ¥¬ é¡µé¢åˆå§‹åŒ–å®Œæˆ');
            } else {
                // è¿æ¥å¤±è´¥ï¼Œä½†ä»ç„¶å°è¯•åŠ è½½æœ¬åœ°ç¼“å­˜
                console.log('ä½¿ç”¨æœ¬åœ°ç¼“å­˜æ•°æ®');
                await loadFriendsData();
                updateLoading('', false);
                showNotification('ä½¿ç”¨æœ¬åœ°ç¼“å­˜æ•°æ®ï¼Œäº‘ç«¯è¿æ¥å¤±è´¥', 'warning');
            }
            
            // 5. æ·»åŠ äº¤äº’æ•ˆæœ
            document.querySelectorAll('.btn').forEach(btn => {
                btn.addEventListener('mousedown', () => {
                    btn.style.transform = 'translateY(0)';
                });
                
                btn.addEventListener('mouseup', () => {
                    btn.style.transform = 'translateY(-3px)';
                });
                
                btn.addEventListener('mouseleave', () => {
                    btn.style.transform = 'translateY(0)';
                });
            });
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        setTimeout(() => {
            init();
        }, 500);
        
    </script>
</body>
</html>
