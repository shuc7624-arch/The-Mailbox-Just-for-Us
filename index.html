<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¥¬çš„æ¸©é¦¨æ—¶å…‰ç•™è¨€ç°¿ - å¥½å‹æ¡£æ¡ˆç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=ZCOOL+XiaoWei&display=swap" rel="stylesheet">
    <!-- å¼•å…¥ Supabase å®¢æˆ·ç«¯ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* åŸæœ‰æ ·å¼ä¿æŒä¸å˜ï¼Œè¿™é‡Œåªæ·»åŠ æ–°å¢çš„æ ·å¼ */
        
        /* ç½‘ç»œçŠ¶æ€æŒ‡ç¤ºå™¨å¢å¼º */
        .connection-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 18px;
            border-radius: 15px;
            font-size: 0.9rem;
            z-index: 1000;
            font-family: 'Ma Shan Zheng', cursive;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            max-width: 300px;
        }
        
        .connection-status.online {
            background: linear-gradient(90deg, var(--primary-color) 0%, #7C9EB2 100%);
            color: white;
            border: 2px solid var(--primary-color);
        }
        
        .connection-status.offline {
            background: linear-gradient(90deg, #FFAAA5 0%, #FF7A7A 100%);
            color: white;
            border: 2px solid #FF7A7A;
        }
        
        .connection-status.connecting {
            background: linear-gradient(90deg, #FFD3B6 0%, #FFAAA5 100%);
            color: var(--text-color);
            border: 2px solid #FFD3B6;
        }
        
        .connection-status.hidden {
            transform: translateY(100%);
            opacity: 0;
        }
        
        .connection-status:not(.hidden) {
            transform: translateY(0);
            opacity: 1;
        }
        
        .connection-status i {
            font-size: 1.2rem;
        }
        
        .retry-btn {
            margin-left: 10px;
            padding: 5px 10px;
            background-color: white;
            border: none;
            border-radius: 10px;
            color: var(--dark-color);
            font-weight: 600;
            cursor: pointer;
            font-family: 'Ma Shan Zheng', cursive;
            transition: all 0.3s;
        }
        
        .retry-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
        }
        
        /* åŠ è½½æŒ‡ç¤ºå™¨ */
        .loading-indicator {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* æ¬¢è¿è¯­æ ·å¼ */
        .greeting {
            font-size: 1.5rem;
            text-align: center;
            margin-top: 20px;
            color: var(--accent-color);
            font-family: 'Ma Shan Zheng', cursive;
            min-height: 30px;
        }
        
        /* é¡µé¢åŠ è½½é®ç½© */
        .page-loader {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }
        
        .page-loader.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .loader-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        .loader-text {
            color: white;
            font-size: 1.2rem;
            font-family: 'Ma Shan Zheng', cursive;
            text-align: center;
        }
        
        /* æ•°æ®ç»Ÿè®¡æ ·å¼ */
        .stats-info {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            font-size: 0.9rem;
            color: var(--dark-color);
        }
        
        .stat-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* ç®€åŒ–ç‰ˆæ•°æ®å¤‡ä»½æé†’ */
        .backup-notice {
            background-color: rgba(168, 230, 207, 0.2);
            border: 2px dashed var(--primary-color);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            text-align: center;
            color: var(--dark-color);
        }
    </style>
</head>
<body>
    <!-- é¡µé¢åŠ è½½é®ç½© -->
    <div class="page-loader" id="page-loader">
        <div class="loader-spinner"></div>
        <div class="loader-text">ğŸ¥¬ æ­£åœ¨åŠ è½½æ—¶å…‰ç•™è¨€ç°¿...</div>
        <div class="loader-text" id="loader-detail" style="font-size: 1rem; margin-top: 10px;"></div>
    </div>
    
    <!-- èƒŒæ™¯è£…é¥°å…ƒç´  -->
    <div class="decoration dec-1">ğŸ¥¬</div>
    <div class="decoration dec-2">ğŸ¥¬</div>
    <div class="decoration dec-3">ğŸ¥¬</div>
    <div class="decoration dec-4">ğŸ¥¬</div>
    <div class="decoration dec-5">ğŸ¥¬</div>
    
    <!-- ç½‘ç»œçŠ¶æ€æŒ‡ç¤ºå™¨ -->
    <div id="connection-status" class="connection-status hidden">
        <i class="fas fa-wifi"></i>
        <span>æ­£åœ¨è¿æ¥äº‘ç«¯...</span>
    </div>
    
    <div class="container">
        <header>
            <div class="title-container">
                <h1><span>ğŸ¥¬</span> çš„å°å®‡å®™ <span>ğŸ¥¬</span></h1>
                <p>è®°å½•ğŸ¥¬å’Œæœ‹å‹ä»¬çš„ç¾å¥½æ—¶å…‰ï¼Œç•™è¨€äº’åŠ¨ï¼Œäº‘ç«¯ä¿å­˜ï¼</p>
                <div class="greeting" id="greeting">ğŸ¥¬çš„æ¸©é¦¨æ—¶å…‰å°å±‹å·²å‡†å¤‡å°±ç»ª</div>
                <div class="stats-info" id="stats-info">
                    <div class="stat-item">
                        <i class="fas fa-users"></i>
                        <span id="friend-count">0</span> ä½å¥½å‹
                    </div>
                    <div class="stat-item">
                        <i class="fas fa-comments"></i>
                        <span id="message-count">0</span> æ¡ç•™è¨€
                    </div>
                    <div class="stat-item">
                        <i class="fas fa-cloud"></i>
                        <span id="connection-type">ç¦»çº¿</span>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- è§†å›¾åˆ‡æ¢å™¨å’Œä¸»å†…å®¹ä¿æŒä¸å˜ -->
        <div class="view-switcher">
            <button class="view-btn active" id="admin-btn">
                <i class="fas fa-heart"></i> ğŸ¥¬çš„ç®¡ç†ç©ºé—´
            </button>
            <button class="view-btn" id="user-btn">
                <i class="fas fa-user-friends"></i> æœ‹å‹æ¥è®¿å…¥å£
            </button>
        </div>
        
        <!-- ç®¡ç†å‘˜è§†è§’ -->
        <div class="view-container active" id="admin-view">
            <div class="password-section" id="password-section">
                <h3 class="section-title"><i class="fas fa-lock"></i> ğŸ¥¬çš„èº«ä»½éªŒè¯</h3>
                <div class="input-group">
                    <label for="admin-password">è¯·è¾“å…¥ğŸ¥¬çš„ä¸“å±å¯†ç </label>
                    <input type="password" id="admin-password" placeholder="åªæœ‰ğŸ¥¬çŸ¥é“çš„ç¥ç§˜å¯†ç ...">
                </div>
                <button class="btn" id="login-btn">
                    <i class="fas fa-door-open"></i> è¿›å…¥ğŸ¥¬çš„æ—¶å…‰å°å±‹
                </button>
                <div class="backup-notice">
                    <i class="fas fa-database"></i> æ•°æ®äº‘ç«¯ä¿å­˜ï¼Œæ”¯æŒå¤šè®¾å¤‡åŒæ­¥è®¿é—®
                    <div style="font-size: 0.8rem; margin-top: 5px;">
                        é‡åˆ°è¿æ¥é—®é¢˜ï¼Ÿ<button class="retry-btn" id="init-retry-btn">ç‚¹å‡»é‡è¯•</button>
                    </div>
                </div>
            </div>
            
            <div class="admin-view hidden" id="admin-content">
                <!-- ç®¡ç†å‘˜å†…å®¹ä¿æŒä¸å˜ -->
            </div>
        </div>
        
        <!-- ç”¨æˆ·è§†è§’ -->
        <div class="view-container" id="user-view">
            <!-- ç”¨æˆ·å†…å®¹ä¿æŒä¸å˜ -->
        </div>
        
        <footer>
            <p>Â© ğŸ¥¬çš„æ¸©é¦¨æ—¶å…‰ç•™è¨€ç°¿ | æ•°æ®äº‘ç«¯ä¿å­˜ï¼Œå¤šè®¾å¤‡åŒæ­¥è®¿é—®</p>
            <p style="margin-top: 10px;">ğŸ¥¬ ä¼šä¸€ç›´è®°å½•ä¸æ¯ä½æœ‹å‹çš„ç¾å¥½æ—¶å…‰ ğŸ¥¬</p>
            <p style="font-size: 0.9rem; margin-top: 5px; color: var(--dark-color);">
                <i class="fas fa-cloud"></i> äº‘ç«¯å­˜å‚¨ä¿éšœæ•°æ®å®‰å…¨ | 
                <i class="fas fa-sync-alt"></i> è‡ªåŠ¨åŒæ­¥æ›´æ–°
            </p>
        </footer>
    </div>
    
    <!-- æ¨¡æ€æ¡†å’Œé€šçŸ¥ç»„ä»¶ä¿æŒä¸å˜ -->
    
    <script>
        // ç­‰å¾…DOMå®Œå…¨åŠ è½½
        document.addEventListener('DOMContentLoaded', function() {
            
            console.log("ğŸ¥¬ é¡µé¢è„šæœ¬å·²æˆåŠŸåŠ è½½");
            
            // ========== å¢å¼ºé…ç½®éƒ¨åˆ† ==========
            const SUPABASE_CONFIG = {
                url: 'https://dqgtsupdmtzlbvsunelk.supabase.co',  // æ›¿æ¢ä¸ºä½ çš„ Supabase URL
                key: 'sb_publishable_IE-qGn0KjRLgmySR9C3Fvw_A3QXeReN',  // æ›¿æ¢ä¸ºä½ çš„ Supabase anon key
                timeout: 10000, // 10ç§’è¶…æ—¶
                retryCount: 3,  // é‡è¯•æ¬¡æ•°
                retryDelay: 2000 // é‡è¯•å»¶è¿Ÿ2ç§’
            };
            
            const ADMIN_PASSWORD = "v05708";
            
            // ========== åˆå§‹åŒ–å˜é‡ ==========
            let supabase;
            let isOnline = false;
            let retryCount = 0;
            let maxRetries = 3;
            let connectionCheckInterval;
            let lastConnectionTime = Date.now();
            
            // çº¯è‰²å¤´åƒé¢œè‰²æ•°ç»„
            const avatarColors = ['avatar-color-1', 'avatar-color-2', 'avatar-color-3', 'avatar-color-4', 'avatar-color-5', 'avatar-color-6'];
            
            // å½“å‰é€‰ä¸­çš„å¥½å‹
            let currentFriend = null;
            let currentFilter = "all";
            let managingFriend = null;
            let friendsDataCache = [];
            
            // ========== DOM å…ƒç´  ==========
            const pageLoader = document.getElementById('page-loader');
            const loaderDetail = document.getElementById('loader-detail');
            const connectionStatus = document.getElementById('connection-status');
            const greeting = document.getElementById('greeting');
            const statsInfo = document.getElementById('stats-info');
            const friendCount = document.getElementById('friend-count');
            const messageCount = document.getElementById('message-count');
            const connectionType = document.getElementById('connection-type');
            const initRetryBtn = document.getElementById('init-retry-btn');
            
            // åŸæœ‰DOMå…ƒç´ è·å–ä¿æŒä¸å˜
            const adminBtn = document.getElementById('admin-btn');
            const userBtn = document.getElementById('user-btn');
            const adminView = document.getElementById('admin-view');
            const userView = document.getElementById('user-view');
            const passwordSection = document.getElementById('password-section');
            const adminContent = document.getElementById('admin-content');
            const loginBtn = document.getElementById('login-btn');
            const adminPasswordInput = document.getElementById('admin-password');
            const friendForm = document.getElementById('friend-form');
            const friendNameInput = document.getElementById('friend-name');
            const adminMessageInput = document.getElementById('admin-message');
            const friendList = document.getElementById('friend-list');
            const userNameInput = document.getElementById('user-name');
            const searchBtn = document.getElementById('search-btn');
            const userResult = document.getElementById('user-result');
            const timelineSection = document.getElementById('timeline-section');
            const newMessageSection = document.getElementById('new-message-section');
            const userMessageInput = document.getElementById('user-message');
            const sendMessageBtn = document.getElementById('send-message-btn');
            const notificationContainer = document.getElementById('notification-container');
            const timelineFilter = document.getElementById('timeline-filter');
            const adminBackBtn = document.getElementById('admin-back-btn');
            const userBackBtn = document.getElementById('user-back-btn');
            
            // ç®¡ç†æ¨¡æ€æ¡†å…ƒç´ 
            const manageFriendModal = document.getElementById('manage-friend-modal');
            const closeManageModalBtn = document.getElementById('close-manage-modal');
            const manageFriendNameInput = document.getElementById('manage-friend-name');
            const manageAdminMessageInput = document.getElementById('manage-admin-message');
            const manageNewMessageInput = document.getElementById('manage-new-message');
            const saveManageBtn = document.getElementById('save-manage-btn');
            const addMessageBtn = document.getElementById('add-message-btn');
            
            // ========== å¢å¼ºè¾…åŠ©å‡½æ•° ==========
            
            // æ›´æ–°è¿æ¥çŠ¶æ€æ˜¾ç¤º
            function updateConnectionStatus(status, message, showRetry = false) {
                if (!connectionStatus) return;
                
                isOnline = status === 'online';
                lastConnectionTime = Date.now();
                
                connectionStatus.className = `connection-status ${status}`;
                
                let statusHtml = `<i class="fas fa-${status === 'online' ? 'wifi' : status === 'connecting' ? 'sync fa-spin' : 'exclamation-triangle'}"></i>`;
                
                if (status === 'connecting') {
                    statusHtml += `<div class="loading-indicator"></div>`;
                }
                
                statusHtml += `<span>${message}</span>`;
                
                if (showRetry && status !== 'online') {
                    statusHtml += `<button class="retry-btn" id="status-retry-btn">é‡è¯•</button>`;
                }
                
                connectionStatus.innerHTML = statusHtml;
                
                // æ˜¾ç¤ºè¿æ¥çŠ¶æ€
                connectionStatus.classList.remove('hidden');
                
                // å¦‚æœè¿æ¥æˆåŠŸï¼Œ3ç§’åéšè—çŠ¶æ€
                if (status === 'online') {
                    setTimeout(() => {
                        connectionStatus.classList.add('hidden');
                    }, 3000);
                }
                
                // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                connectionType.textContent = status === 'online' ? 'åœ¨çº¿' : 'ç¦»çº¿';
                
                // æ·»åŠ é‡è¯•æŒ‰é’®äº‹ä»¶ç›‘å¬
                if (showRetry) {
                    setTimeout(() => {
                        const statusRetryBtn = document.getElementById('status-retry-btn');
                        if (statusRetryBtn) {
                            statusRetryBtn.addEventListener('click', initSupabase);
                        }
                    }, 100);
                }
            }
            
            // æ£€æŸ¥ç½‘ç»œè¿æ¥
            function checkNetworkConnection() {
                return navigator.onLine;
            }
            
            // æ›´æ–°åŠ è½½å™¨è¯¦æƒ…
            function updateLoaderDetail(message) {
                if (loaderDetail) {
                    loaderDetail.textContent = message;
                }
            }
            
            // éšè—é¡µé¢åŠ è½½å™¨
            function hidePageLoader() {
                if (pageLoader) {
                    setTimeout(() => {
                        pageLoader.classList.add('hidden');
                    }, 500);
                }
            }
            
            // æ˜¾ç¤ºé¡µé¢åŠ è½½å™¨
            function showPageLoader() {
                if (pageLoader) {
                    pageLoader.classList.remove('hidden');
                }
            }
            
            // æ›´æ–°ç»Ÿè®¡æ•°æ®
            function updateStats() {
                const totalFriends = friendsDataCache.length;
                const totalMessages = friendsDataCache.reduce((sum, friend) => {
                    return sum + (friend.messages ? friend.messages.length : 0);
                }, 0);
                
                friendCount.textContent = totalFriends;
                messageCount.textContent = totalMessages;
                
                if (totalFriends > 0) {
                    greeting.textContent = `ğŸ¥¬å·²è®°å½•${totalFriends}ä½å¥½å‹ï¼Œ${totalMessages}æ¡ç•™è¨€`;
                } else {
                    greeting.textContent = 'ğŸ¥¬çš„æ¸©é¦¨æ—¶å…‰å°å±‹å·²å‡†å¤‡å°±ç»ª';
                }
            }
            
            // æµ‹è¯•Supabaseè¿æ¥
            async function testSupabaseConnection() {
                if (!supabase) return false;
                
                try {
                    updateLoaderDetail('æ­£åœ¨æµ‹è¯•æ•°æ®åº“è¿æ¥...');
                    
                    // è®¾ç½®è¶…æ—¶
                    const timeoutPromise = new Promise((_, reject) => {
                        setTimeout(() => reject(new Error('è¿æ¥è¶…æ—¶')), 5000);
                    });
                    
                    // æµ‹è¯•æŸ¥è¯¢
                    const testPromise = supabase
                        .from('friends')
                        .select('count', { count: 'exact', head: true });
                    
                    const { data, error } = await Promise.race([testPromise, timeoutPromise]);
                    
                    if (error) {
                        console.error('æ•°æ®åº“è¿æ¥æµ‹è¯•å¤±è´¥:', error);
                        return false;
                    }
                    
                    console.log('æ•°æ®åº“è¿æ¥æµ‹è¯•æˆåŠŸï¼Œè®°å½•æ•°:', data);
                    return true;
                } catch (error) {
                    console.error('è¿æ¥æµ‹è¯•å¼‚å¸¸:', error);
                    return false;
                }
            }
            
            // åˆå§‹åŒ–Supabaseè¿æ¥
            async function initSupabase() {
                // æ£€æŸ¥ç½‘ç»œ
                if (!checkNetworkConnection()) {
                    updateConnectionStatus('offline', 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ', true);
                    updateLoaderDetail('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ');
                    showNotification('è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•', 'error');
                    return false;
                }
                
                // æ£€æŸ¥é…ç½®
                if (!SUPABASE_CONFIG.url || !SUPABASE_CONFIG.key || 
                    SUPABASE_CONFIG.url.includes('ä½ çš„é¡¹ç›®id') || 
                    SUPABASE_CONFIG.key.includes('ä½ çš„åŒ¿åå…¬é’¥')) {
                    
                    updateConnectionStatus('offline', 'è¯·å…ˆé…ç½®æ•°æ®åº“è¿æ¥', false);
                    updateLoaderDetail('è¯·å…ˆé…ç½®æ•°æ®åº“è¿æ¥');
                    
                    const configError = `
                        ğŸ¥¬ éœ€è¦é…ç½®æ•°æ®åº“è¿æ¥ï¼š
                        <br>1. è®¿é—® supabase.com æ³¨å†Œè´¦å·
                        <br>2. åˆ›å»ºæ–°é¡¹ç›®ï¼Œè·å– URL å’Œ anon key
                        <br>3. ä¿®æ”¹ä»£ç ä¸­çš„ SUPABASE_CONFIG
                    `;
                    
                    showNotification('è¯·å…ˆé…ç½®æ•°æ®åº“è¿æ¥', 'error');
                    
                    // åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºé…ç½®è¯´æ˜
                    if (greeting) {
                        greeting.innerHTML = configError;
                    }
                    
                    return false;
                }
                
                try {
                    updateConnectionStatus('connecting', 'æ­£åœ¨è¿æ¥äº‘ç«¯æ•°æ®åº“...', false);
                    updateLoaderDetail('æ­£åœ¨åˆå§‹åŒ–æ•°æ®åº“è¿æ¥...');
                    
                    // åˆ›å»ºSupabaseå®¢æˆ·ç«¯
                    supabase = window.supabase.createClient(
                        SUPABASE_CONFIG.url, 
                        SUPABASE_CONFIG.key,
                        {
                            auth: {
                                persistSession: false,
                                autoRefreshToken: false,
                                detectSessionInUrl: false
                            }
                        }
                    );
                    
                    console.log("Supabaseå®¢æˆ·ç«¯åˆ›å»ºæˆåŠŸ");
                    
                    // æµ‹è¯•è¿æ¥
                    const isConnected = await testSupabaseConnection();
                    
                    if (isConnected) {
                        updateConnectionStatus('online', 'å·²è¿æ¥åˆ°äº‘ç«¯æ•°æ®åº“', false);
                        updateLoaderDetail('æ•°æ®åº“è¿æ¥æˆåŠŸï¼ŒåŠ è½½æ•°æ®ä¸­...');
                        console.log("ğŸ¥¬ Supabaseè¿æ¥æˆåŠŸ");
                        return true;
                    } else {
                        updateConnectionStatus('offline', 'æ•°æ®åº“è¿æ¥å¤±è´¥', true);
                        updateLoaderDetail('æ•°æ®åº“è¿æ¥å¤±è´¥');
                        console.error("ğŸ¥¬ Supabaseè¿æ¥å¤±è´¥");
                        return false;
                    }
                } catch (error) {
                    console.error("åˆå§‹åŒ–Supabaseå¤±è´¥:", error);
                    updateConnectionStatus('offline', `è¿æ¥å¤±è´¥: ${error.message}`, true);
                    updateLoaderDetail('æ•°æ®åº“è¿æ¥å¼‚å¸¸');
                    return false;
                }
            }
            
            // å¸¦é‡è¯•æœºåˆ¶çš„æ•°æ®åŠ è½½
            async function loadWithRetry(operation, operationName, maxRetries = 3) {
                let lastError;
                
                for (let attempt = 1; attempt <= maxRetries; attempt++) {
                    try {
                        updateLoaderDetail(`${operationName} (å°è¯• ${attempt}/${maxRetries})...`);
                        
                        const result = await operation();
                        
                        if (attempt > 1) {
                            console.log(`${operationName} åœ¨ç¬¬ ${attempt} æ¬¡å°è¯•åæˆåŠŸ`);
                        }
                        
                        return result;
                    } catch (error) {
                        lastError = error;
                        console.warn(`${operationName} å°è¯• ${attempt} å¤±è´¥:`, error);
                        
                        if (attempt < maxRetries) {
                            // ç­‰å¾…ä¸€æ®µæ—¶é—´åé‡è¯•
                            await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
                        }
                    }
                }
                
                throw lastError;
            }
            
            // ä»SupabaseåŠ è½½æ‰€æœ‰å¥½å‹æ•°æ®ï¼ˆå¸¦é‡è¯•ï¼‰
            async function loadFriendsData() {
                if (!supabase) {
                    throw new Error('æ•°æ®åº“è¿æ¥æœªåˆå§‹åŒ–');
                }
                
                return loadWithRetry(async () => {
                    const { data, error } = await supabase
                        .from('friends')
                        .select('*')
                        .order('created_at', { ascending: false });
                    
                    if (error) {
                        throw new Error(`åŠ è½½æ•°æ®å¤±è´¥: ${error.message}`);
                    }
                    
                    console.log('ä»SupabaseåŠ è½½çš„æ•°æ®:', data);
                    
                    // è½¬æ¢æ•°æ®æ ¼å¼
                    const formattedData = (data || []).map(item => ({
                        id: item.id,
                        name: item.name,
                        adminMessage: item.admin_message || '',
                        avatarColor: item.avatar_color || getAvatarColor(item.name),
                        messages: item.messages || [],
                        timeline: item.timeline || [],
                        created_at: item.created_at
                    }));
                    
                    // ä¸ºæ¯ä¸ªå¥½å‹æ›´æ–°æ—¶é—´çº¿
                    formattedData.forEach(friend => updateFriendTimeline(friend));
                    
                    // æ›´æ–°ç¼“å­˜
                    friendsDataCache = formattedData;
                    
                    // æ›´æ–°ç»Ÿè®¡æ•°æ®
                    updateStats();
                    
                    return formattedData;
                }, 'åŠ è½½å¥½å‹æ•°æ®', maxRetries);
            }
            
            // åŸæœ‰è¾…åŠ©å‡½æ•°ä¿æŒä¸å˜
            function getAvatarColor(name) {
                if (!name) return 'avatar-color-1';
                let sum = 0;
                for (let i = 0; i < name.length; i++) {
                    sum += name.charCodeAt(i);
                }
                return avatarColors[sum % avatarColors.length];
            }
            
            function getInitials(name) {
                if (!name) return '?';
                if (/[\u4e00-\u9fa5]/.test(name)) {
                    return name.charAt(0);
                }
                return name.charAt(0).toUpperCase();
            }
            
            function generateSolidAvatar(name, size = 'small') {
                const colorClass = getAvatarColor(name);
                const initials = getInitials(name);
                
                if (size === 'large') {
                    return `<div class="friend-profile-img ${colorClass}">${initials}</div>`;
                } else {
                    return `<div class="friend-avatar ${colorClass}">${initials}</div>`;
                }
            }
            
            function updateFriendTimeline(friend) {
                if (!friend || !friend.messages) return;
                
                friend.timeline = [];
                
                if (friend.messages && friend.messages.length > 0) {
                    friend.messages.forEach(message => {
                        friend.timeline.push({
                            ...message,
                            type: "message"
                        });
                    });
                }
                
                friend.timeline.sort((a, b) => new Date(b.time) - new Date(a.time));
            }
            
            // æ˜¾ç¤ºé€šçŸ¥
            function showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.innerHTML = `<span>${message}</span>`;
                
                notificationContainer.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.animation = 'slideIn 0.5s ease reverse';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.remove();
                        }
                    }, 500);
                }, 3000);
            }
            
            // ========== æ•°æ®æ“ä½œå‡½æ•° ==========
            
            // ä¿å­˜å¥½å‹æ•°æ®åˆ°Supabase
            async function saveFriendData(friend) {
                if (!supabase) {
                    showNotification('æ•°æ®åº“è¿æ¥æœªåˆå§‹åŒ–', 'error');
                    return null;
                }
                
                return loadWithRetry(async () => {
                    updateFriendTimeline(friend);
                    
                    const friendData = {
                        name: friend.name,
                        admin_message: friend.adminMessage,
                        avatar_color: friend.avatarColor,
                        messages: friend.messages,
                        timeline: friend.timeline,
                        updated_at: new Date().toISOString()
                    };
                    
                    let result;
                    
                    if (!friend.id) {
                        friendData.created_at = new Date().toISOString();
                        const { data, error } = await supabase
                            .from('friends')
                            .insert([friendData])
                            .select();
                        
                        if (error) throw error;
                        result = data[0];
                    } else {
                        const { data, error } = await supabase
                            .from('friends')
                            .update(friendData)
                            .eq('id', friend.id)
                            .select();
                        
                        if (error) throw error;
                        result = data[0];
                    }
                    
                    // åˆ·æ–°ç¼“å­˜
                    await loadFriendsData();
                    
                    return result;
                }, 'ä¿å­˜å¥½å‹æ•°æ®', 2);
            }
            
            // ä»Supabaseåˆ é™¤å¥½å‹
            async function deleteFriendData(friendId) {
                if (!supabase) {
                    showNotification('æ•°æ®åº“è¿æ¥æœªåˆå§‹åŒ–', 'error');
                    return false;
                }
                
                return loadWithRetry(async () => {
                    const { error } = await supabase
                        .from('friends')
                        .delete()
                        .eq('id', friendId);
                    
                    if (error) throw error;
                    
                    // åˆ·æ–°ç¼“å­˜
                    await loadFriendsData();
                    
                    return true;
                }, 'åˆ é™¤å¥½å‹æ•°æ®', 2);
            }
            
            // è·å–å•ä¸ªå¥½å‹
            async function getFriendById(friendId) {
                if (!supabase) return null;
                
                try {
                    const { data, error } = await supabase
                        .from('friends')
                        .select('*')
                        .eq('id', friendId)
                        .single();
                    
                    if (error) {
                        // å°è¯•ä»ç¼“å­˜è·å–
                        const cachedFriend = friendsDataCache.find(f => f.id === friendId);
                        if (cachedFriend) {
                            console.log('ä»ç¼“å­˜è·å–å¥½å‹æ•°æ®');
                            return cachedFriend;
                        }
                        throw error;
                    }
                    
                    return {
                        id: data.id,
                        name: data.name,
                        adminMessage: data.admin_message || '',
                        avatarColor: data.avatar_color || getAvatarColor(data.name),
                        messages: data.messages || [],
                        timeline: data.timeline || [],
                        created_at: data.created_at
                    };
                } catch (error) {
                    console.error('è·å–å¥½å‹å¤±è´¥:', error);
                    const cachedFriend = friendsDataCache.find(f => f.id === friendId);
                    return cachedFriend || null;
                }
            }
            
            // é€šè¿‡åå­—æœç´¢å¥½å‹
            async function searchFriendByName(name) {
                if (!name || !name.trim()) return null;
                
                // å…ˆå°è¯•ä»ç¼“å­˜æŸ¥æ‰¾
                const cachedFriend = friendsDataCache.find(f => 
                    f.name.toLowerCase() === name.toLowerCase()
                );
                
                if (cachedFriend) {
                    return cachedFriend;
                }
                
                // ç¼“å­˜ä¸­æ²¡æœ‰ï¼Œå°è¯•ä»æ•°æ®åº“æŸ¥æ‰¾
                if (!supabase) return null;
                
                try {
                    const { data, error } = await supabase
                        .from('friends')
                        .select('*')
                        .ilike('name', name)
                        .limit(1);
                    
                    if (error || !data || data.length === 0) return null;
                    
                    const dbFriend = data[0];
                    return {
                        id: dbFriend.id,
                        name: dbFriend.name,
                        adminMessage: dbFriend.admin_message || '',
                        avatarColor: dbFriend.avatar_color || getAvatarColor(dbFriend.name),
                        messages: dbFriend.messages || [],
                        timeline: dbFriend.timeline || [],
                        created_at: dbFriend.created_at
                    };
                } catch (error) {
                    console.error('æœç´¢å¥½å‹å¤±è´¥:', error);
                    return null;
                }
            }
            
            // ========== æ˜¾ç¤ºç›¸å…³å‡½æ•° ==========
            
            // åŠ è½½å¥½å‹åˆ—è¡¨
            async function loadFriendsList() {
                console.log("å¼€å§‹åŠ è½½å¥½å‹åˆ—è¡¨...");
                
                if (!supabase) {
                    friendList.innerHTML = `
                        <div class="no-data">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>æ•°æ®åº“è¿æ¥å¤±è´¥</p>
                            <button class="retry-btn" onclick="location.reload()">åˆ·æ–°é¡µé¢</button>
                        </div>
                    `;
                    return;
                }
                
                friendList.innerHTML = `
                    <div class="no-data">
                        <div class="loading-indicator"></div>
                        <p>æ­£åœ¨ä»äº‘ç«¯åŠ è½½å¥½å‹æ¡£æ¡ˆ...</p>
                    </div>
                `;
                
                try {
                    const friendsData = await loadFriendsData();
                    
                    if (friendsData.length === 0) {
                        friendList.innerHTML = `
                            <div class="no-data">
                                <i class="fas fa-users"></i>
                                <p>è¿˜æ²¡æœ‰å¥½å‹æ¡£æ¡ˆï¼Œå¿«ä¸ºä½ çš„æœ‹å‹åˆ›å»ºä¸€ä¸ªå§ï¼</p>
                            </div>
                        `;
                        return;
                    }
                    
                    // æ¸…ç©ºå½“å‰åˆ—è¡¨
                    friendList.innerHTML = '';
                    
                    friendsData.forEach(friend => {
                        const avatarHtml = generateSolidAvatar(friend.name, 'small');
                        
                        const friendItem = document.createElement('div');
                        friendItem.className = 'friend-item';
                        friendItem.innerHTML = `
                            ${avatarHtml}
                            <div class="friend-info">
                                <h4>${friend.name}</h4>
                                <p>${friend.adminMessage.substring(0, 60)}${friend.adminMessage.length > 60 ? '...' : ''}</p>
                                <p style="font-size: 0.9rem; color: var(--accent-color); margin-top: 5px;">
                                    <i class="fas fa-comments"></i> ${friend.messages ? friend.messages.length : 0} æ¡ç•™è¨€
                                </p>
                            </div>
                            <div class="friend-actions">
                                <button class="action-btn view-friend-btn" data-id="${friend.id}">
                                    <i class="fas fa-heart"></i>
                                </button>
                                <button class="action-btn manage-friend-btn" data-id="${friend.id}">
                                    <i class="fas fa-cog"></i>
                                </button>
                                <button class="action-btn delete-friend-btn" data-id="${friend.id}">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        `;
                        
                        friendList.appendChild(friendItem);
                    });
                    
                    // æ·»åŠ äº‹ä»¶ç›‘å¬
                    addFriendListEventListeners();
                    
                } catch (error) {
                    console.error('åŠ è½½å¥½å‹åˆ—è¡¨å¤±è´¥:', error);
                    friendList.innerHTML = `
                        <div class="no-data">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>åŠ è½½å¥½å‹æ¡£æ¡ˆå¤±è´¥</p>
                            <p style="font-size: 0.9rem; margin-top: 10px;">${error.message}</p>
                            <button class="retry-btn" id="retry-friends-btn">é‡è¯•åŠ è½½</button>
                        </div>
                    `;
                    
                    // æ·»åŠ é‡è¯•æŒ‰é’®äº‹ä»¶
                    setTimeout(() => {
                        const retryBtn = document.getElementById('retry-friends-btn');
                        if (retryBtn) {
                            retryBtn.addEventListener('click', loadFriendsList);
                        }
                    }, 100);
                }
            }
            
            // æ·»åŠ å¥½å‹åˆ—è¡¨äº‹ä»¶ç›‘å¬å™¨
            function addFriendListEventListeners() {
                document.querySelectorAll('.view-friend-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const friendId = parseInt(e.currentTarget.getAttribute('data-id'));
                        viewFriend(friendId);
                    });
                });
                
                document.querySelectorAll('.manage-friend-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const friendId = parseInt(e.currentTarget.getAttribute('data-id'));
                        openManageModal(friendId);
                    });
                });
                
                document.querySelectorAll('.delete-friend-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const friendId = parseInt(e.currentTarget.getAttribute('data-id'));
                        deleteFriend(friendId);
                    });
                });
            }
            
            // é‡ç½®ç”¨æˆ·æœç´¢ç•Œé¢
            function resetUserSearch() {
                userResult.innerHTML = `
                    <div class="no-data">
                        <i class="fas fa-heart"></i>
                        <p>è¾“å…¥ä½ çš„åå­—ï¼Œçœ‹çœ‹ğŸ¥¬ç»™ä½ ç•™äº†ä»€ä¹ˆè¯</p>
                    </div>
                `;
                timelineSection.innerHTML = `
                    <div class="no-data">
                        <i class="fas fa-clock"></i>
                        <p>æ‰¾åˆ°ä½ çš„æ¡£æ¡ˆåï¼Œå¯ä»¥åœ¨è¿™é‡ŒæŸ¥çœ‹ğŸ¥¬ä¸ºä½ è®°å½•çš„æ—¶å…‰</p>
                    </div>
                `;
                newMessageSection.classList.add('hidden');
                userNameInput.value = '';
                userBackBtn.classList.add('hidden');
            }
            
            // æ˜¾ç¤ºå¥½å‹æ¡£æ¡ˆ
            async function displayFriendProfile(friend) {
                if (!friend) return;
                
                currentFriend = friend;
                
                const avatarHtml = generateSolidAvatar(friend.name, 'large');
                
                userResult.innerHTML = `
                    <div class="friend-profile">
                        <div class="friend-avatar-container">
                            ${avatarHtml}
                        </div>
                        <h3>${friend.name}</h3>
                        <p>æ¬¢è¿æ¥åˆ°ä½ çš„ä¸“å±æ¡£æ¡ˆï¼ğŸ¥¬ä¸ºä½ è®°å½•äº†ä¸€äº›ç¾å¥½æ—¶åˆ»ï½</p>
                    </div>
                `;
                
                displayTimeline(friend);
                newMessageSection.classList.remove('hidden');
                userMessageInput.value = '';
                userMessageInput.focus();
                userBackBtn.classList.remove('hidden');
            }
            
            // æ˜¾ç¤ºæ—¶é—´çº¿
            function displayTimeline(friend) {
                if (!friend || !friend.timeline) {
                    timelineSection.innerHTML = `
                        <div class="no-data">
                            <i class="fas fa-clock"></i>
                            <p>è¿˜æ²¡æœ‰æ—¶é—´çº¿è®°å½•</p>
                        </div>
                    `;
                    return;
                }
                
                let filteredTimeline = friend.timeline;
                if (currentFilter === 'message') {
                    filteredTimeline = friend.timeline.filter(item => item.type === 'message');
                }
                
                if (filteredTimeline.length === 0) {
                    timelineSection.innerHTML = `
                        <div class="no-data">
                            <i class="fas fa-clock"></i>
                            <p>è¿˜æ²¡æœ‰æ—¶é—´çº¿è®°å½•</p>
                        </div>
                    `;
                    return;
                }
                
                timelineSection.innerHTML = '<div class="timeline">';
                
                filteredTimeline.forEach(item => {
                    const timelineItem = document.createElement('div');
                    timelineItem.className = 'timeline-item';
                    
                    if (item.type === 'message') {
                        timelineItem.innerHTML = `
                            <div class="timeline-icon">
                                <i class="fas fa-comment"></i>
                            </div>
                            <div class="timeline-content">
                                <div class="timeline-header">
                                    <span class="timeline-sender">${item.sender}</span>
                                    <span class="timeline-time">${item.time}</span>
                                </div>
                                <div class="timeline-message">${item.content}</div>
                            </div>
                        `;
                    }
                    
                    timelineSection.querySelector('.timeline').appendChild(timelineItem);
                });
                
                timelineSection.innerHTML += '</div>';
            }
            
            // ========== äº‹ä»¶ç›‘å¬å™¨ ==========
            
            // è§†è§’åˆ‡æ¢
            adminBtn.addEventListener('click', () => {
                adminBtn.classList.add('active');
                userBtn.classList.remove('active');
                adminView.classList.add('active');
                userView.classList.remove('active');
                
                adminContent.classList.add('hidden');
                passwordSection.classList.remove('hidden');
                adminPasswordInput.value = '';
            });
            
            userBtn.addEventListener('click', () => {
                userBtn.classList.add('active');
                adminBtn.classList.remove('active');
                userView.classList.add('active');
                adminView.classList.remove('active');
                
                resetUserSearch();
                currentFriend = null;
            });
            
            // ç®¡ç†å‘˜ç™»å½•
            loginBtn.addEventListener('click', () => {
                const password = adminPasswordInput.value;
                
                if (password === ADMIN_PASSWORD) {
                    passwordSection.classList.add('hidden');
                    adminContent.classList.remove('hidden');
                    showNotification('æ¬¢è¿å›æ¥ï¼ŒğŸ¥¬ï¼', 'success');
                    loadFriendsList();
                } else {
                    showNotification('å¯†ç ä¸å¯¹å“¦ï¼Œå†è¯•è¯•çœ‹ï¼', 'error');
                    adminPasswordInput.value = '';
                    adminPasswordInput.focus();
                }
            });
            
            // ç®¡ç†å‘˜è¿”å›ç™»å½•æŒ‰é’®
            adminBackBtn.addEventListener('click', () => {
                adminContent.classList.add('hidden');
                passwordSection.classList.remove('hidden');
                adminPasswordInput.value = '';
            });
            
            // ç”¨æˆ·è¿”å›æœç´¢æŒ‰é’®
            userBackBtn.addEventListener('click', () => {
                resetUserSearch();
                currentFriend = null;
            });
            
            // åˆ›å»ºå¥½å‹æ¡£æ¡ˆ
            friendForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const name = friendNameInput.value.trim();
                const adminMessage = adminMessageInput.value.trim();
                
                if (!name) {
                    showNotification('è¯·è¾“å…¥å¥½å‹çš„åå­—å“¦ï¼', 'error');
                    return;
                }
                
                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨åŒåå¥½å‹
                const existingFriend = await searchFriendByName(name);
                if (existingFriend) {
                    showNotification('å·²ç»æœ‰åŒåå¥½å‹çš„æ¡£æ¡ˆå•¦ï¼æ¢ä¸ªåå­—è¯•è¯•ï¼Ÿ', 'error');
                    return;
                }
                
                const now = new Date();
                const timeString = now.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                }).replace(/\//g, '-');
                
                const avatarColor = getAvatarColor(name);
                
                const newFriend = {
                    name: name,
                    adminMessage: adminMessage || "ğŸ¥¬æƒ³å¯¹ä½ è¯´ï¼šå¾ˆé«˜å…´è®¤è¯†ä½ ï¼",
                    avatarColor: avatarColor,
                    messages: [],
                    timeline: []
                };
                
                const initialMessage = {
                    sender: "ğŸ¥¬",
                    content: adminMessage || "ğŸ¥¬æƒ³å¯¹ä½ è¯´ï¼šå¾ˆé«˜å…´è®¤è¯†ä½ ï¼",
                    time: timeString,
                    type: "message"
                };
                newFriend.messages.push(initialMessage);
                newFriend.timeline.push(initialMessage);
                
                const savedFriend = await saveFriendData(newFriend);
                
                if (savedFriend) {
                    friendForm.reset();
                    
                    setTimeout(() => {
                        loadFriendsList();
                        showNotification(`å¥½å‹ "${name}" çš„æ¡£æ¡ˆåˆ›å»ºæˆåŠŸï¼ğŸ¥¬`, 'success');
                    }, 50);
                }
            });
            
            // æŸ¥çœ‹å¥½å‹æ¡£æ¡ˆ
            async function viewFriend(friendId) {
                const friend = await getFriendById(friendId);
                if (!friend) {
                    showNotification('æ‰¾ä¸åˆ°å¥½å‹æ¡£æ¡ˆ', 'error');
                    return;
                }
                
                userBtn.click();
                userNameInput.value = friend.name;
                displayFriendProfile(friend);
            }
            
            // åˆ é™¤å¥½å‹æ¡£æ¡ˆ
            async function deleteFriend(friendId) {
                const friend = await getFriendById(friendId);
                if (!friend) return;
                
                if (confirm(`ç¡®å®šè¦åˆ é™¤å¥½å‹ "${friend.name}" çš„æ¡£æ¡ˆå—ï¼Ÿè¿™å°†ä¼šåˆ é™¤æ‰€æœ‰ç•™è¨€è®°å½•ã€‚`)) {
                    const success = await deleteFriendData(friendId);
                    
                    if (success) {
                        setTimeout(() => {
                            loadFriendsList();
                            showNotification(`å¥½å‹ "${friend.name}" çš„æ¡£æ¡ˆå·²åˆ é™¤æˆåŠŸï¼`, 'info');
                        }, 50);
                    }
                }
            }
            
            // æ—¶é—´çº¿è¿‡æ»¤å™¨
            timelineFilter.addEventListener('click', (e) => {
                if (e.target.classList.contains('filter-btn')) {
                    document.querySelectorAll('.filter-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    e.target.classList.add('active');
                    
                    currentFilter = e.target.getAttribute('data-filter');
                    
                    if (currentFriend) {
                        displayTimeline(currentFriend);
                    }
                }
            });
            
            // ç”¨æˆ·æœç´¢å¥½å‹æ¡£æ¡ˆ
            searchBtn.addEventListener('click', searchFriend);
            
            userNameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    searchFriend();
                }
            });
            
            async function searchFriend() {
                const name = userNameInput.value.trim();
                
                if (!name) {
                    showNotification('è¯·è¾“å…¥ä½ çš„åå­—å“¦ï¼', 'error');
                    return;
                }
                
                const friend = await searchFriendByName(name);
                
                if (friend) {
                    displayFriendProfile(friend);
                } else {
                    userResult.innerHTML = `
                        <div class="no-data">
                            <i class="fas fa-user-slash"></i>
                            <p style="color: #FF7A7A;">è¯·ç§èŠğŸ¥¬å¹¶è€å¿ƒç­‰å¾…ä¸€ä¼šå“¦~</p>
                            <p style="margin-top: 10px; font-size: 1rem;">ğŸ¥¬è¿˜æ²¡æœ‰åˆ›å»ºä½ çš„æ¡£æ¡ˆ</p>
                        </div>
                    `;
                    
                    timelineSection.innerHTML = `
                        <div class="no-data">
                            <i class="fas fa-clock"></i>
                            <p>è¿˜æ²¡æœ‰æ—¶é—´çº¿è®°å½•</p>
                        </div>
                    `;
                    
                    newMessageSection.classList.add('hidden');
                    userBackBtn.classList.remove('hidden');
                    currentFriend = null;
                }
            }
            
            // å‘é€ç•™è¨€ï¼ˆç”¨æˆ·ï¼‰
            sendMessageBtn.addEventListener('click', async () => {
                if (!currentFriend) {
                    showNotification('è¯·å…ˆæŸ¥æ‰¾ä½ çš„æ¡£æ¡ˆï¼', 'error');
                    return;
                }
                
                const message = userMessageInput.value.trim();
                
                if (!message) {
                    showNotification('è¯·è¾“å…¥ç•™è¨€å†…å®¹å“¦ï¼', 'error');
                    return;
                }
                
                const now = new Date();
                const timeString = now.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                }).replace(/\//g, '-');
                
                const newMessage = {
                    sender: currentFriend.name,
                    content: message,
                    time: timeString,
                    type: 'message'
                };
                
                const friend = await getFriendById(currentFriend.id);
                if (!friend) {
                    showNotification('å¥½å‹æ¡£æ¡ˆåŠ è½½å¤±è´¥', 'error');
                    return;
                }
                
                if (!friend.messages) friend.messages = [];
                friend.messages.push(newMessage);
                
                updateFriendTimeline(friend);
                
                const saved = await saveFriendData(friend);
                
                if (saved) {
                    currentFriend = friend;
                    displayTimeline(friend);
                    userMessageInput.value = '';
                    
                    showNotification('ç•™è¨€å‘é€æˆåŠŸï¼ğŸ¥¬ä¼šå¾ˆå¿«å›å¤ä½ çš„ï¼', 'success');
                    
                    setTimeout(async () => {
                        const replies = [
                            "æ”¶åˆ°ä½ çš„ç•™è¨€å•¦ï¼Œå¥½å¼€å¿ƒï¼",
                            "è°¢è°¢ä½ çš„ç•™è¨€ï¼Œæˆ‘ä¼šä¸€ç›´çæƒœæˆ‘ä»¬çš„å‹è°Šï¼",
                            "çœ‹åˆ°ä½ çš„ç•™è¨€å¿ƒé‡Œæš–æš–çš„ï¼",
                            "è°¢è°¢å…³å¿ƒï¼Œä½ ä¹Ÿè¦ç…§é¡¾å¥½è‡ªå·±å“¦ï¼",
                            "å·²æ”¶åˆ°ï¼ŒæœŸå¾…ä¸‹æ¬¡è§é¢ï¼",
                            "ä½ çš„ç•™è¨€è®©æˆ‘ä»Šå¤©çš„å¿ƒæƒ…éƒ½å˜å¥½äº†ï¼",
                            "å‹è°Šä¸‡å²ï¼ğŸ¥¬æ°¸è¿œæ˜¯ä½ çš„æœ‹å‹ï¼"
                        ];
                        
                        const randomReply = replies[Math.floor(Math.random() * replies.length)];
                        
                        const replyMessage = {
                            sender: "ğŸ¥¬",
                            content: randomReply,
                            time: new Date(now.getTime() + 60000).toLocaleString('zh-CN', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit'
                            }).replace(/\//g, '-'),
                            type: 'message'
                        };
                        
                        const updatedFriend = await getFriendById(currentFriend.id);
                        if (!updatedFriend) return;
                        
                        updatedFriend.messages.push(replyMessage);
                        updateFriendTimeline(updatedFriend);
                        await saveFriendData(updatedFriend);
                        displayTimeline(updatedFriend);
                        
                        showNotification('ğŸ¥¬å›å¤äº†ä½ çš„ç•™è¨€ï¼', 'info');
                    }, 2000);
                }
            });
            
            // æ‰“å¼€ç®¡ç†æ¨¡æ€æ¡†
            async function openManageModal(friendId) {
                const friend = await getFriendById(friendId);
                if (!friend) {
                    showNotification('åŠ è½½å¥½å‹æ¡£æ¡ˆå¤±è´¥', 'error');
                    return;
                }
                
                managingFriend = friend;
                manageFriendNameInput.value = friend.name;
                manageAdminMessageInput.value = friend.adminMessage;
                manageNewMessageInput.value = '';
                manageFriendModal.classList.add('active');
            }
            
            // ä¿å­˜ç®¡ç†æ›´æ”¹
            saveManageBtn.addEventListener('click', async () => {
                if (!managingFriend) return;
                
                managingFriend.adminMessage = manageAdminMessageInput.value.trim() || managingFriend.adminMessage;
                
                const newMessageContent = manageNewMessageInput.value.trim();
                if (newMessageContent) {
                    const now = new Date();
                    const timeString = now.toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    }).replace(/\//g, '-');
                    
                    const newMessage = {
                        sender: "ğŸ¥¬",
                        content: newMessageContent,
                        time: timeString,
                        type: 'message'
                    };
                    
                    managingFriend.messages.push(newMessage);
                }
                
                updateFriendTimeline(managingFriend);
                
                const saved = await saveFriendData(managingFriend);
                
                if (saved) {
                    manageNewMessageInput.value = '';
                    setTimeout(() => {
                        loadFriendsList();
                    }, 50);
                    manageFriendModal.classList.remove('active');
                    showNotification(`å¥½å‹ "${managingFriend.name}" çš„æ¡£æ¡ˆå·²æ›´æ–°æˆåŠŸï¼ğŸ¥¬`, 'success');
                }
            });
            
            // ä»…æ·»åŠ ç•™è¨€æŒ‰é’®
            addMessageBtn.addEventListener('click', async () => {
                if (!managingFriend) return;
                
                const newMessageContent = manageNewMessageInput.value.trim();
                if (!newMessageContent) {
                    showNotification('è¯·è¾“å…¥ç•™è¨€å†…å®¹ï¼', 'error');
                    return;
                }
                
                const now = new Date();
                const timeString = now.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                }).replace(/\//g, '-');
                
                const newMessage = {
                    sender: "ğŸ¥¬",
                    content: newMessageContent,
                    time: timeString,
                    type: 'message'
                };
                
                managingFriend.messages.push(newMessage);
                updateFriendTimeline(managingFriend);
                
                const saved = await saveFriendData(managingFriend);
                
                if (saved) {
                    manageNewMessageInput.value = '';
                    setTimeout(() => {
                        loadFriendsList();
                    }, 50);
                    showNotification(`å·²ä¸º "${managingFriend.name}" æ·»åŠ æ–°ç•™è¨€æˆåŠŸï¼ğŸ¥¬`, 'success');
                }
            });
            
            // å…³é—­ç®¡ç†æ¨¡æ€æ¡†
            closeManageModalBtn.addEventListener('click', () => {
                manageFriendModal.classList.remove('active');
            });
            
            manageFriendModal.addEventListener('click', (e) => {
                if (e.target === manageFriendModal) {
                    manageFriendModal.classList.remove('active');
                }
            });
            
            // åˆå§‹åŒ–é‡è¯•æŒ‰é’®
            if (initRetryBtn) {
                initRetryBtn.addEventListener('click', () => {
                    location.reload();
                });
            }
            
            // ========== ç½‘ç»œè¿æ¥ç›‘æ§ ==========
            
            // ç›‘å¬ç½‘ç»œçŠ¶æ€å˜åŒ–
            window.addEventListener('online', () => {
                console.log('ç½‘ç»œå·²æ¢å¤');
                updateConnectionStatus('online', 'ç½‘ç»œå·²è¿æ¥', false);
                showNotification('ç½‘ç»œè¿æ¥å·²æ¢å¤', 'success');
                
                // å°è¯•é‡æ–°è¿æ¥æ•°æ®åº“
                setTimeout(() => {
                    initSupabase().then(connected => {
                        if (connected) {
                            loadFriendsList();
                        }
                    });
                }, 1000);
            });
            
            window.addEventListener('offline', () => {
                console.log('ç½‘ç»œå·²æ–­å¼€');
                updateConnectionStatus('offline', 'ç½‘ç»œè¿æ¥æ–­å¼€', true);
                showNotification('ç½‘ç»œè¿æ¥å·²æ–­å¼€ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½å—é™', 'error');
            });
            
            // å®šæœŸæ£€æŸ¥è¿æ¥çŠ¶æ€
            function startConnectionMonitor() {
                if (connectionCheckInterval) {
                    clearInterval(connectionCheckInterval);
                }
                
                connectionCheckInterval = setInterval(() => {
                    if (!checkNetworkConnection()) {
                        updateConnectionStatus('offline', 'ç½‘ç»œè¿æ¥å¼‚å¸¸', true);
                    } else if (isOnline && Date.now() - lastConnectionTime > 30000) {
                        // 30ç§’æ— æ´»åŠ¨ï¼Œæ£€æŸ¥è¿æ¥
                        testSupabaseConnection().then(connected => {
                            if (!connected) {
                                updateConnectionStatus('offline', 'äº‘ç«¯è¿æ¥å¼‚å¸¸', true);
                            }
                        });
                    }
                }, 15000); // æ¯15ç§’æ£€æŸ¥ä¸€æ¬¡
            }
            
            // ========== åˆå§‹åŒ–é¡µé¢ ==========
            async function init() {
                console.log("ğŸ¥¬ æ­£åœ¨åˆå§‹åŒ–é¡µé¢...");
                showPageLoader();
                
                // å¯åŠ¨è¿æ¥ç›‘æ§
                startConnectionMonitor();
                
                // åˆå§‹åŒ–Supabaseè¿æ¥
                updateLoaderDetail('æ­£åœ¨è¿æ¥äº‘ç«¯æ•°æ®åº“...');
                const connected = await initSupabase();
                
                if (connected) {
                    updateLoaderDetail('åŠ è½½å¥½å‹æ•°æ®ä¸­...');
                    
                    try {
                        // åŠ è½½å¥½å‹æ•°æ®
                        await loadFriendsData();
                        
                        // æ›´æ–°ç»Ÿè®¡æ•°æ®
                        updateStats();
                        
                        console.log("ğŸ¥¬ é¡µé¢åˆå§‹åŒ–å®Œæˆ");
                        showNotification('ğŸ¥¬çš„æ—¶å…‰ç•™è¨€ç°¿å·²å°±ç»ªï¼', 'success');
                        
                        // å»¶è¿Ÿéšè—åŠ è½½å™¨ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æˆåŠŸçŠ¶æ€
                        setTimeout(() => {
                            hidePageLoader();
                        }, 1000);
                        
                    } catch (error) {
                        console.error('åˆå§‹åŒ–æ•°æ®å¤±è´¥:', error);
                        updateLoaderDetail('æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•');
                        updateConnectionStatus('offline', 'æ•°æ®åŠ è½½å¤±è´¥', true);
                        hidePageLoader();
                    }
                } else {
                    console.error("ğŸ¥¬ æ•°æ®åº“è¿æ¥å¤±è´¥");
                    updateLoaderDetail('æ•°æ®åº“è¿æ¥å¤±è´¥');
                    hidePageLoader();
                }
                
                // æ·»åŠ äº¤äº’æ•ˆæœ
                document.querySelectorAll('.btn').forEach(btn => {
                    btn.addEventListener('mousedown', () => {
                        btn.style.transform = 'translateY(0)';
                    });
                    
                    btn.addEventListener('mouseup', () => {
                        btn.style.transform = 'translateY(-3px)';
                    });
                    
                    btn.addEventListener('mouseleave', () => {
                        btn.style.transform = 'translateY(0)';
                    });
                });
            }
            
            // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
            setTimeout(() => {
                init();
            }, 500);
            
        }); // DOMContentLoaded ç»“æŸ
    </script>
</body>
</html>
