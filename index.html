<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>å¥½å‹æ¡£æ¡ˆ Â· äº‘ç«¯ç‰ˆ</title>
<style>
body { font-family: Arial; background:#f5f5f5; padding:20px; }
.card { background:#fff; padding:15px; margin-bottom:15px; border-radius:8px; }
img { width:90px; margin:5px; border-radius:6px; }
button { padding:6px 12px; cursor:pointer; }
input, textarea { width:100%; margin:6px 0; }
.admin { background:#ffe; padding:10px; border-radius:8px; }
</style>
</head>

<body>

<h1>ğŸ“˜ å¥½å‹æ¡£æ¡ˆï¼ˆFirebase äº‘ç«¯ç‰ˆï¼‰</h1>

<div class="card admin">
<h3>ğŸ” ç®¡ç†å‘˜æ“ä½œ</h3>
<input id="adminPass" type="password" placeholder="è¾“å…¥ç®¡ç†å‘˜å¯†ç ">
<button onclick="login()">è¿›å…¥ç®¡ç†æ¨¡å¼</button>
</div>

<div class="card" id="editor" style="display:none">
<h3>â• æ·»åŠ å¥½å‹</h3>
<input id="name" placeholder="å¥½å‹åå­—">
<textarea id="msg" placeholder="ä½ æƒ³è¯´çš„è¯"></textarea>
<input type="file" id="photos" multiple>
<button onclick="createFriend()">ä¿å­˜</button>
</div>

<h2>ğŸ“š å¥½å‹åˆ—è¡¨</h2>
<div id="list"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc } 
from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } 
from "https://www.gstatic.com/firebasejs/12.7.0/firebase-storage.js";

/* ğŸ”¥ ä½ çš„ Firebase é…ç½® */
const firebaseConfig = {
  apiKey: "AIzaSyDrhnxOtyUgVl2ct3B9WEqeE0ZIOSJUKvM",
  authDomain: "vespace-90d84.firebaseapp.com",
  projectId: "vespace-90d84",
  storageBucket: "vespace-90d84.firebasestorage.app",
  messagingSenderId: "1068019656250",
  appId: "1:1068019656250:web:0015fefa2e5e1b2296b703"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

let isAdmin = false;
const ADMIN_PASSWORD = "123456"; // â†ä½ å¯ä»¥æ”¹

// ç™»å½•
window.login = () => {
  if (document.getElementById("adminPass").value === ADMIN_PASSWORD) {
    isAdmin = true;
    document.getElementById("editor").style.display = "block";
    alert("ç®¡ç†å‘˜æ¨¡å¼å¼€å¯");
  } else {
    alert("å¯†ç é”™è¯¯");
  }
};

// ä¸Šä¼ å›¾ç‰‡
async function uploadImage(file) {
  if (!file.type.startsWith("image/")) return null;
  if (file.size > 2 * 1024 * 1024) {
    alert("å›¾ç‰‡ä¸èƒ½è¶…è¿‡2MB");
    return null;
  }

  const name = crypto.randomUUID();
  const refImg = ref(storage, `photos/${name}`);
  await uploadBytes(refImg, file);

  return {
    url: await getDownloadURL(refImg),
    path: `photos/${name}`
  };
}

// åˆ›å»ºå¥½å‹
window.createFriend = async () => {
  const name = document.getElementById("name").value;
  const msg = document.getElementById("msg").value;
  const files = document.getElementById("photos").files;

  const photos = [];
  for (const f of files) {
    const p = await uploadImage(f);
    if (p) photos.push(p);
  }

  await addDoc(collection(db, "friends"), {
    name,
    msg,
    photos,
    time: new Date().toLocaleString()
  });

  alert("ä¿å­˜æˆåŠŸ");
  load();
};

// è¯»å–
async function load() {
  const list = document.getElementById("list");
  list.innerHTML = "";

  const snap = await getDocs(collection(db, "friends"));
  snap.forEach(d => {
    const f = d.data();
    const div = document.createElement("div");
    div.className = "card";

    div.innerHTML = `
      <h3>${f.name}</h3>
      <p>${f.msg}</p>
      ${f.photos.map(p => `<img src="${p.url}">`).join("")}
      ${isAdmin ? `<br><button onclick="del('${d.id}', ${JSON.stringify(f.photos).replace(/"/g,'&quot;')})">åˆ é™¤</button>` : ""}
    `;

    list.appendChild(div);
  });
}

// åˆ é™¤
window.del = async (id, photos) => {
  if (!confirm("ç¡®å®šåˆ é™¤ï¼Ÿ")) return;

  for (const p of photos) {
    await deleteObject(ref(storage, p.path));
  }

  await deleteDoc(doc(db, "friends", id));
  load();
};

load();
</script>

</body>
</html>
